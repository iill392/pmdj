<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¸é¾™å¹³æ°‘ç”µç«ç‚¹å•</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- ç®€åŒ–çš„äº‘å­˜å‚¨SDK -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding-bottom: 55px;
            font-size: 14px;
        }
        
        /* æ³¨å†Œ/ç™»å½•å¼¹çª— */
        .modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 16px;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            text-align: center;
            color: #FFD700;
        }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.12);
            color: white;
            font-size: 0.9rem;
        }
        
        .modal-select {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.12);
            color: white;
            font-size: 0.9rem;
        }
        
        .modal-btn {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: linear-gradient(45deg, #FF512F, #DD2476);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(221, 36, 118, 0.5);
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            display: none;
        }
        
        /* å¤´éƒ¨ - æç®€è®¾è®¡ */
        header {
            text-align: center;
            margin-bottom: 15px;
            padding-top: 5px;
        }
        
        /* æç®€æ ‡é¢˜ */
        h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
            background: linear-gradient(to right, #ff8a00, #da1b60);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-weight: 700;
            line-height: 1.2;
        }
        
        .subtitle {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
            line-height: 1.2;
            padding: 0 5px;
        }
        
        /* åº•éƒ¨å¯¼èˆª - æ›´ç´§å‡‘ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: space-around;
            padding: 6px 0;
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            padding: 3px 0;
        }
        
        .nav-item.active {
            color: #FFD700;
        }
        
        .nav-icon {
            font-size: 1rem;
            margin-bottom: 2px;
        }
        
        /* é¡µé¢å†…å®¹ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* é¡µé¢æ ‡é¢˜ */
        .page h2 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #FFD700;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ä¸»é¡µ - æ›´ç´§å‡‘çš„è®¢å•ç½‘æ ¼ */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .order-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.2s;
            min-height: 120px;
            display: flex;
            flex-direction: column;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
        
        .order-card.sold-out {
            opacity: 0.6;
            filter: grayscale(0.4);
        }
        
        .order-card.sold-out .order-title {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .order-card.sold-out .order-btn {
            background: linear-gradient(45deg, #555, #777);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .order-card.sold-out .order-btn:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* ç­¾åˆ°è®¢å•ç‰¹æ®Šæ ·å¼ */
        .order-card.daily-sign {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            animation: pulse-glow 3s infinite alternate;
        }
        
        @keyframes pulse-glow {
            from {
                box-shadow: 0 3px 8px rgba(255, 215, 0, 0.1);
            }
            to {
                box-shadow: 0 3px 12px rgba(255, 215, 0, 0.3);
            }
        }
        
        .order-card.daily-sign .order-title {
            color: #FFD700;
        }
        
        .order-card.daily-sign .order-btn {
            background: linear-gradient(45deg, #FFD700, #FF8A00);
            color: #1a2a6c;
            font-weight: 700;
        }
        
        .order-card.daily-sign .order-btn:disabled {
            background: linear-gradient(45deg, #555, #777);
            color: rgba(255, 255, 255, 0.7);
            cursor: not-allowed;
        }
        
        .order-card.daily-sign .order-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .order-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: #FFD700;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .order-price-range {
            font-size: 0.8rem;
            color: #ff6b6b;
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .order-original-price {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
            text-decoration: line-through;
            margin-bottom: 4px;
        }
        
        .order-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
            line-height: 1.2;
            flex-grow: 1;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .order-btn {
            width: 100%;
            padding: 6px;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }
        
        /* åˆ†ç±»é¡µé¢ */
        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .category {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category.active {
            background: rgba(255, 215, 0, 0.25);
            color: #FFD700;
            font-weight: 600;
        }
        
        /* å®¢æœé¡µé¢ */
        .chat-container {
            height: 380px;
            overflow-y: auto;
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .message-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
            overflow-y: auto;
        }
        
        .message-item {
            padding: 8px 10px;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .user-message {
            background: rgba(33, 150, 243, 0.25);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .admin-message {
            background: rgba(76, 175, 80, 0.25);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
            opacity: 0.8;
        }
        
        .message-content {
            font-size: 0.85rem;
            line-height: 1.3;
        }
        
        .message-input-area {
            display: flex;
            gap: 6px;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        #messageInput {
            flex: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
        }
        
        #sendMessageBtn {
            padding: 0 12px;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            transition: all 0.2s;
        }
        
        #sendMessageBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* å‘é€ä¸­åŠ¨ç”» */
        .sending-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        
        .sending-text {
            font-size: 0.8rem;
        }
        
        .no-messages {
            text-align: center;
            padding: 25px 12px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }
        
        /* æˆ‘çš„é¡µé¢ */
        .profile {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 12px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-info h2 {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .user-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
        }
        
        /* é€€å‡ºç™»å½•æŒ‰é’® */
        #logoutBtn {
            width: auto;
            padding: 5px 10px;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        
        .review-status {
            margin-top: 16px;
        }
        
        .review-status h3 {
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: #FFD700;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            position: relative;
        }
        
        .status-title {
            font-size: 0.85rem;
            margin-bottom: 6px;
            color: #FFD700;
        }
        
        .status-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            margin-bottom: 3px;
            line-height: 1.3;
        }
        
        /* é€€æ¬¾æŒ‰é’® */
        .refund-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
        }
        
        .refund-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(238, 90, 82, 0.3);
        }
        
        .refund-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* ä¸‹å•å¼¹çª— */
        .order-modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        
        .order-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 16px;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .order-modal-title {
            font-size: 1rem;
            margin-bottom: 6px;
            text-align: center;
            color: #FFD700;
        }
        
        /* è§„æ ¼é€‰æ‹©æç¤º */
        .specs-instruction {
            text-align: center;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 2px solid #FFD700;
        }
        
        .specs-modal {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .spec-modal {
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .spec-modal:hover {
            background: rgba(255, 215, 0, 0.2);
        }
        
        .spec-modal.active {
            background: rgba(255, 215, 0, 0.4);
            color: #FFD700;
        }
        
        .spec-name {
            flex: 1;
            text-align: left;
        }
        
        .spec-price {
            font-weight: 600;
            color: #ff6b6b;
            font-size: 0.9rem;
        }
        
        /* æ”¯ä»˜å¼¹çª— - ä¿®æ”¹ï¼šåˆ é™¤å–æ¶ˆæŒ‰é’® */
        .payment-modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        
        .payment-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 16px;
            width: 90%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .payment-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #FFD700;
            line-height: 1.3;
        }
        
        .payment-amount {
            font-size: 1.2rem;
            margin: 12px 0;
            color: #ff6b6b;
            font-weight: 700;
        }
        
        .payment-notice {
            margin: 12px 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            line-height: 1.3;
        }
        
        /* å®¡æ ¸å¼¹çª— */
        .review-modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        
        .review-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 16px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .review-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .review-message {
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            line-height: 1.3;
        }
        
        /* ç­¾åˆ°å¼¹çª— */
        .sign-modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        
        .sign-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .sign-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #FFD700;
        }
        
        .sign-fragments {
            font-size: 2.5rem;
            margin: 15px 0;
            color: #FFD700;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        
        .sign-message {
            margin: 15px 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        /* åå°ç®¡ç† */
        .admin-panel {
            position: fixed;
            top: 6px;
            right: 6px;
            z-index: 100;
        }
        
        .admin-btn {
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        
        .admin-modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        
        .admin-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 16px;
            width: 95%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .admin-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            text-align: center;
            color: #FFD700;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .admin-header h2 {
            margin: 0;
        }
        
        .refresh-btn {
            padding: 5px 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        /* åå°ç®¡ç†æ ‡ç­¾é¡µ */
        .admin-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .admin-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 0.75rem;
        }
        
        .admin-tab:last-child {
            border-right: none;
        }
        
        .admin-tab.active {
            background: rgba(255, 215, 0, 0.25);
            color: #FFD700;
            font-weight: 600;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 16px;
        }
        
        .admin-section h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .user-list, .order-list, .message-list-admin, .refund-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .user-item, .order-item, .message-item-admin, .refund-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.75rem;
            position: relative;
        }
        
        .message-content-admin {
            margin: 6px 0;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        
        .reply-input {
            width: 100%;
            padding: 6px;
            margin: 6px 0;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.75rem;
        }
        
        .reply-btn {
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-bottom: 6px;
        }
        
        .order-actions, .refund-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        
        .approve-btn, .reject-btn {
            padding: 3px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .approve-btn {
            background: #4CAF50;
            color: white;
        }
        
        .reject-btn {
            background: #f44336;
            color: white;
        }
        
        /* åˆ é™¤æ•°æ®æŒ‰é’® */
        .delete-data-btn {
            padding: 6px 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-top: 12px;
            transition: all 0.2s;
        }
        
        .replies-container {
            margin-top: 6px;
            padding-left: 10px;
            border-left: 2px solid rgba(255, 215, 0, 0.2);
        }
        
        .reply-item {
            background: rgba(76, 175, 80, 0.2);
            border-radius: 5px;
            padding: 6px;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .reply-time {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 3px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-text {
            margin-top: 10px;
            text-align: center;
            color: white;
            font-size: 0.9rem;
        }
        
        /* ä¸‹å•åŠ è½½åŠ¨ç”» */
        .order-loading {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
        }
        
        .order-loading-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 280px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .order-loading-title {
            font-size: 1rem;
            margin-bottom: 12px;
            color: #FFD700;
        }
        
        .order-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #FFD700;
            margin: 0 auto 12px;
            animation: spin 1s ease-in-out infinite;
        }
        
        .order-loading-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }
        
        /* æŠ½å¥–å¼¹çª— */
        .lottery-modal {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .lottery-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 12px;
            width: 95%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin: 12px auto;
        }
        
        .lottery-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .lottery-description {
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .prizes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
            max-height: 240px;
            overflow-y: auto;
            padding: 4px;
        }
        
        .prize-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .prize-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .prize-item.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
            transform: scale(1.02);
        }
        
        .prize-item.winning {
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            from {
                box-shadow: 0 0 6px rgba(255, 215, 0, 0.3);
            }
            to {
                box-shadow: 0 0 12px rgba(255, 215, 0, 0.5);
            }
        }
        
        .prize-name {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #FFD700;
            line-height: 1.1;
        }
        
        .prize-probability {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 3px;
        }
        
        .prize-original-price {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
            text-decoration: line-through;
            margin-bottom: 2px;
        }
        
        .prize-current-price {
            font-size: 0.8rem;
            color: #ff6b6b;
            font-weight: 600;
        }
        
        .lottery-btn {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: linear-gradient(45deg, #FF512F, #DD2476);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(221, 36, 118, 0.5);
        }
        
        .lottery-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .lottery-result {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: none;
        }
        
        .result-title {
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: #FFD700;
        }
        
        .result-prize {
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 700;
            color: #ff6b6b;
            line-height: 1.2;
        }
        
        .result-message {
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .lottery-spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #FFD700;
            margin: 12px auto;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* è”ç³»å®¢æœæ‚¬æµ®çƒ - æ›´å° */
        .floating-support {
            position: fixed;
            bottom: 50px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #FF512F, #DD2476);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(221, 36, 118, 0.4);
            cursor: pointer;
            z-index: 99;
            transition: all 0.2s ease;
            animation: float 3s ease-in-out infinite;
            padding: 4px;
        }
        
        .floating-support:hover {
            transform: scale(1.08);
            box-shadow: 0 5px 15px rgba(221, 36, 118, 0.6);
            animation-play-state: paused;
        }
        
        .support-icon {
            font-size: 1.4rem;
            color: white;
            margin-bottom: 1px;
        }
        
        .support-text {
            font-size: 0.6rem;
            color: white;
            font-weight: 600;
            text-align: center;
            line-height: 1;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }
        
        /* ç¢ç‰‡æ˜¾ç¤ºæ ·å¼ */
        .fragment-display {
            animation: fragment-pulse 2s infinite alternate;
        }
        
        @keyframes fragment-pulse {
            from {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
            }
            to {
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
        }
        
        /* å“åº”å¼è®¾è®¡ - é’ˆå¯¹å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .orders-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 8px;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .subtitle {
                font-size: 0.7rem;
            }
            
            .profile {
                padding: 10px;
            }
            
            .avatar {
                width: 45px;
                height: 45px;
                margin-right: 10px;
            }
            
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab {
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
            
            .chat-container {
                height: 340px;
            }
            
            /* æŠ½å¥–ç•Œé¢æ‰‹æœºé€‚é… */
            .lottery-content {
                padding: 10px;
                margin: 8px;
            }
            
            .prizes-container {
                grid-template-columns: 1fr;
                gap: 6px;
                max-height: 200px;
            }
            
            .prize-item {
                padding: 8px 5px;
                min-height: 70px;
            }
            
            .prize-name {
                font-size: 0.75rem;
            }
            
            /* ç­¾åˆ°å¼¹çª—æ‰‹æœºé€‚é… */
            .sign-fragments {
                font-size: 2rem;
            }
            
            /* è”ç³»å®¢æœæ‚¬æµ®çƒç§»åŠ¨ç«¯é€‚é… */
            .floating-support {
                bottom: 45px;
                right: 8px;
                width: 45px;
                height: 45px;
            }
            
            .support-icon {
                font-size: 1.2rem;
            }
            
            .support-text {
                font-size: 0.55rem;
            }
        }
        
        /* é’ˆå¯¹éå¸¸å°çš„æ‰‹æœºå±å¹• */
        @media (max-width: 360px) {
            .orders-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .order-card {
                padding: 10px;
                min-height: 110px;
            }
            
            .order-title {
                font-size: 0.8rem;
            }
            
            .order-btn {
                padding: 5px;
                font-size: 0.75rem;
            }
            
            .sign-fragments {
                font-size: 1.8rem;
            }
            
            .floating-support {
                width: 40px;
                height: 40px;
                bottom: 40px;
                right: 6px;
            }
            
            .support-icon {
                font-size: 1rem;
            }
            
            .support-text {
                font-size: 0.5rem;
            }
        }
        
        /* é’ˆå¯¹æ¨ªå±æ¨¡å¼ */
        @media (orientation: landscape) and (max-height: 500px) {
            .orders-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .chat-container {
                height: 200px;
            }
        }
        
        /* æŠ½å¥–æ»šåŠ¨æ¡æ ·å¼ */
        .prizes-container::-webkit-scrollbar {
            width: 3px;
        }
        
        .prizes-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .prizes-container::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.4);
            border-radius: 6px;
        }
        
        .prizes-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.6);
        }
        
        /* æ–°å¢ï¼šæŠ½å¥–æŒ‰é’®å¹¶æ’æ ·å¼ */
        .lottery-buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .lottery-buttons-container .lottery-btn {
            flex: 1;
            margin-top: 0;
            font-size: 0.9rem;
            padding: 10px 5px;
        }
        
        @media (max-width: 360px) {
            .lottery-buttons-container .lottery-btn {
                font-size: 0.85rem;
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- åˆå§‹åŒ–åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
        </div>
    </div>
    
    <!-- ä¸‹å•åŠ è½½åŠ¨ç”» -->
    <div class="order-loading" id="orderLoading">
        <div class="order-loading-content">
            <div class="order-loading-spinner"></div>
            <h2 class="order-loading-title">è®¢å•æäº¤ä¸­</h2>
            <p class="order-loading-text">æ­£åœ¨ä¿å­˜è®¢å•æ•°æ®åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>
    
    <!-- æ¸¸æˆåç§°è¾“å…¥å¼¹çª— -->
    <div class="modal" id="gameNameModal">
        <div class="modal-content">
            <h2 class="modal-title">è¾“å…¥æ¸¸æˆåç§°</h2>
            <input type="text" class="modal-input" id="gameNameInput" placeholder="è¯·è¾“å…¥æ¸¸æˆåç§°">
            <button class="modal-btn" id="gameNameConfirmBtn">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>
    
    <!-- åŒºæœé€‰æ‹©å¼¹çª— -->
    <div class="modal" id="serverModal">
        <div class="modal-content">
            <h2 class="modal-title">é€‰æ‹©åŒºæœ</h2>
            <select class="modal-select" id="serverSelect">
                <option value="">è¯·é€‰æ‹©åŒºæœ</option>
                <option value="QQåŒº">QQåŒº</option>
                <option value="å¾®ä¿¡åŒº">å¾®ä¿¡åŒº</option>
            </select>
            <button class="modal-btn" id="serverConfirmBtn">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>
    
    <!-- å¾®ä¿¡å·/æ‰‹æœºå·è¾“å…¥å¼¹çª— -->
    <div class="modal" id="wechatModal">
        <div class="modal-content">
            <h2 class="modal-title">è¾“å…¥å¾®ä¿¡å·/æ‰‹æœºå·</h2>
            <input type="text" class="modal-input" id="wechatInput1" placeholder="è¯·è¾“å…¥å¾®ä¿¡å·æˆ–æ‰‹æœºå·">
            <input type="text" class="modal-input" id="wechatInput2" placeholder="è¯·å†æ¬¡è¾“å…¥ç¡®è®¤">
            <div id="wechatError" style="color: #ff6b6b; font-size: 0.8rem; margin: 5px 0; display: none;">ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥</div>
            <button class="modal-btn" id="wechatConfirmBtn">è¿›å…¥</button>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container" id="mainContainer">
        <header>
            <h1>æ¸¸é¾™å¹³æ°‘ç”µç«ç‚¹å•</h1>
            <div class="subtitle">å…¨ç½‘æœ€æ€§ä»·æ¯”çš„é¡¶å°–æŠ¤ï¼Œç‚¹å•å‰è¯·å…ˆæ·»åŠ æ¸¸é¾™å¥½å‹ã€ä»¥ä¾¿7å¤©æ— ç†ç”±é€€æ¬¾ã€‘ï¼Œå¾®ä¿¡å·ï¼šyoulong6665</div>
        </header>
        
        <!-- ä¸»é¡µ -->
        <div class="page active" id="homePage">
            <h2>çƒ­é—¨è®¢å•</h2>
            <div class="orders-grid" id="ordersGrid">
                <!-- è®¢å•å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- åˆ†ç±»é¡µé¢ -->
        <div class="page" id="categoryPage">
            <h2>åˆ†ç±»</h2>
            <div class="categories">
                <div class="category active" data-category="all">å…¨éƒ¨</div>
                <div class="category" data-category="equipment">è£…å¤‡</div>
                <div class="category" data-category="skin">æ‰“æ³•</div>
                <div class="category" data-category="vip">VIP</div>
                <div class="category" data-category="other">å…¶ä»–</div>
            </div>
            
            <div class="orders-grid" id="categoryOrdersGrid">
                <!-- åˆ†ç±»è®¢å•å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- å®¢æœé¡µé¢ -->
        <div class="page" id="messagePage">
            <h2>å®¢æœä¸­å¿ƒ</h2>
            <div class="chat-container">
                <div class="message-list" id="messageList">
                    <!-- æ¶ˆæ¯åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="message-input-area">
                    <input type="text" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æ¶ˆæ¯...">
                    <button id="sendMessageBtn">å‘é€</button>
                </div>
            </div>
        </div>
        
        <!-- æˆ‘çš„é¡µé¢ -->
        <div class="page" id="profilePage">
            <h2>æˆ‘çš„ä¿¡æ¯</h2>
            <div class="profile">
                <div class="avatar">
                    <!-- éšæœºå¤´åƒ -->
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSI0MCIgZmlsbD0iIzMzYzhmZiIvPjxjaXJjbGUgY3g9IjQwIiBjeT0iMzAiIHI9IjE1IiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTI1IDYwIEEyMCAyMCA0IDAgMSA1NSA2MCBMNTUgNzAgQTIwIDIwIDAgMCAxIDI1IDcwIFoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=" alt="ç”¨æˆ·å¤´åƒ">
                </div>
                <div class="user-info">
                    <h2 id="userName">ç”¨æˆ·å</h2>
                    <p id="userServer">åŒºæœ: QåŒº</p>
                    <p id="userWechat" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">å¾®ä¿¡å·: </p>
                    <!-- æ–°å¢ï¼šç¢ç‰‡æ•°é‡æ˜¾ç¤º -->
                    <p id="userFragments" style="font-size: 0.7rem; color: #FFD700; margin-top: 2px; font-weight: 600;">
                        <span style="color: rgba(255, 255, 255, 0.7);">ä¼ ä¸–ç¢ç‰‡: </span>
                        <span id="fragmentCountInProfile">0</span> ä¸ª
                    </p>
                    <button class="modal-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            
            <div class="review-status">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="margin: 0;">æˆ‘çš„è®¢å•</h3>
                </div>
                <div id="userOrdersList">
                    <!-- ç”¨æˆ·è®¢å•å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="homePage">
                <div class="nav-icon">ğŸ </div>
                <div>ä¸»é¡µ</div>
            </div>
            <div class="nav-item" data-page="categoryPage">
                <div class="nav-icon">ğŸ“‚</div>
                <div>åˆ†ç±»</div>
            </div>
            <div class="nav-item" data-page="messagePage">
                <div class="nav-icon">ğŸ’¬</div>
                <div>å®¢æœ</div>
            </div>
            <div class="nav-item" data-page="profilePage">
                <div class="nav-icon">ğŸ‘¤</div>
                <div>æˆ‘çš„</div>
            </div>
        </div>
    </div>
    
    <!-- ç­¾åˆ°å¼¹çª— -->
    <div class="sign-modal" id="signModal">
        <div class="sign-content">
            <h2 class="sign-title">ç­¾åˆ°æˆåŠŸï¼</h2>
            <div class="sign-fragments" id="signFragmentsCount">+1</div>
            <p class="sign-message" id="signMessage">
                æ‚¨è·å¾—äº†100ä¸ªä¼ ä¸–ç¢ç‰‡ï¼<br>
                1ä¸‡ä¸ªç¢ç‰‡ç­‰äºéšæœºä¸€æŠŠä¼ ä¸–æ­¦å™¨
            </p>
            <p class="sign-message" style="color: #FFD700; font-size: 0.8rem; margin-top: 10px;">
                å½“å‰ç¢ç‰‡æ€»æ•°: <span id="totalFragmentsCount">0</span> ä¸ª
            </p>
            <button class="modal-btn" id="signCloseBtn" style="margin-top: 20px;">ç¡®å®š</button>
        </div>
    </div>
    
    <!-- ä¸‹å•å¼¹çª— -->
    <div class="order-modal" id="orderModal">
        <div class="order-modal-content">
            <h2 class="order-modal-title" id="orderModalTitle">é€‰æ‹©è§„æ ¼</h2>
            <!-- æ–°å¢ï¼šè§„æ ¼é€‰æ‹©æç¤º -->
            <div class="specs-instruction">è¯·é€‰æ‹©è§„æ ¼ï¼ˆå·²æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åºï¼‰</div>
            <div class="specs-modal" id="specsModal">
                <!-- è§„æ ¼å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="modal-btn" id="confirmOrderBtn">ç¡®è®¤ä¸‹å•</button>
            <button class="modal-btn" style="background: #6c757d; margin-top: 8px;" id="cancelOrderBtn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- ä¼ ä¸–æ­¦å™¨è½¬ç›˜æŠ½å¥–å¼¹çª— -->
    <div class="lottery-modal" id="lotteryModal">
        <div class="lottery-content">
            <h2 class="lottery-title">ä¼ ä¸–æ­¦å™¨è½¬ç›˜æŠ½å¥–</h2>
            <div class="lottery-description">
                ç‚¹å‡»æŠ½å¥–æŒ‰é’®ï¼ŒéšæœºæŠ½å–ä¸€ä»¶ä¼ ä¸–æ­¦å™¨ï¼<br>
                æŠ½ä¸­ä»€ä¹ˆå°±ä¼šè‡ªåŠ¨ä¸‹å•ä»€ä¹ˆï¼Œæ¯å•åªæœ‰ä¸€æ¬¡æŠ½å¥–æœºä¼šï¼
            </div>
            
            <div class="prizes-container" id="prizesContainer">
                <!-- å¥–å“å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="lottery-result" id="lotteryResult">
                <div class="lottery-spinner" id="lotterySpinner"></div>
                <div id="resultContent">
                    <div class="result-title">æŠ½å¥–ç»“æœ</div>
                    <div class="result-prize" id="resultPrize"></div>
                    <div class="result-message" id="resultMessage"></div>
                </div>
            </div>
            
            <button class="lottery-btn" id="startLotteryBtn">å¼€å§‹æŠ½å¥–</button>
            <button class="modal-btn" style="background: #6c757d; margin-top: 8px;" id="cancelLotteryBtn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- ç²‰ä¸ç¦åˆ©æŠ½å¥–ã€ä¼ ä¸–ã€‘å¼¹çª— -->
    <div class="lottery-modal" id="equipmentLotteryModal">
        <div class="lottery-content">
            <h2 class="lottery-title">ç²‰ä¸ç¦åˆ©æŠ½å¥–ã€ä¼ ä¸–ã€‘</h2>
            <!-- æ–°å¢ï¼šç¢ç‰‡æ•°é‡æ˜¾ç¤º -->
            <div class="fragment-display" id="fragmentDisplay" style="text-align: center; margin: 10px 0; padding: 8px; background: rgba(255, 215, 0, 0.1); border-radius: 6px; border: 1px solid rgba(255, 215, 0, 0.3);">
                <div style="font-size: 0.9rem; color: #FFD700; margin-bottom: 3px;">æ‚¨çš„ä¼ ä¸–ç¢ç‰‡</div>
                <div style="font-size: 1.1rem; font-weight: 700; color: #ff6b6b;" id="fragmentCount">åŠ è½½ä¸­...</div>
                <div style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.6); margin-top: 3px;">ç´¯è®¡æŠ½å¥–è·å¾—</div>
            </div>
            <div class="lottery-description">
                1ä¸‡ä¸ªç¢ç‰‡å¯è·å¾—1æŠŠä¼ ä¸–æ­¦å™¨<br>
                æŠ½ä¸­ä»€ä¹ˆå°±ä¼šè‡ªåŠ¨ä¸‹å•ä»€ä¹ˆï¼Œæ¯å•åªæœ‰ä¸€æ¬¡æŠ½å¥–æœºä¼šï¼
            </div>
            
            <div class="prizes-container" id="equipmentPrizesContainer">
                <!-- è£…å¤‡å¥–å“å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="lottery-result" id="equipmentLotteryResult">
                <div class="lottery-spinner" id="equipmentLotterySpinner"></div>
                <div id="equipmentResultContent">
                    <div class="result-title">æŠ½å¥–ç»“æœ</div>
                    <div class="result-prize" id="equipmentResultPrize"></div>
                    <div class="result-message" id="equipmentResultMessage"></div>
                </div>
            </div>
            
            <!-- ä¿®æ”¹ï¼šå°†åŸæ¥çš„ä¸€ä¸ªæŒ‰é’®æ”¹ä¸ºä¸¤ä¸ªæŒ‰é’®å¹¶æ’ -->
            <div class="lottery-buttons-container">
                <button class="lottery-btn" id="startEquipmentLotteryBtn">æŠ½ä¸€æ¬¡ (Â¥0.01)</button>
                <button class="lottery-btn" id="start10EquipmentLotteryBtn">æŠ½åæ¬¡ (Â¥0.10)</button>
            </div>
            <button class="modal-btn" style="background: #6c757d; margin-top: 8px;" id="cancelEquipmentLotteryBtn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- æ”¯ä»˜å¼¹çª— - ä¿®æ”¹ï¼šåˆ é™¤å–æ¶ˆæŒ‰é’® -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-content">
            <h2 class="payment-title">è¯·å®Œæˆæ”¯ä»˜ã€å¦‚ä¸‹å•å1å°æ—¶æœªæ”¯ä»˜å°†ä¸ä¼šç»™æ‚¨æ´¾å•ã€‘</h2>
            <div class="payment-amount" id="paymentAmount">Â¥0.00</div>
            <div class="payment-notice">
                è¯·æ·»åŠ å®¢æœå¾®ä¿¡å®Œæˆæ”¯ä»˜ã€å¦‚ä¸‹å•å1å°æ—¶æœªä»˜æ¬¾å°†ä¸ä¼šç»™æ‚¨æ´¾å•ã€‘<br>
                å¾®ä¿¡å·ã€é•¿æŒ‰å¤åˆ¶ã€‘: <strong>youlong6665</strong><br>
                æ”¯ä»˜é‡‘é¢: <span id="paymentAmountText">Â¥0.00</span>
            </div>
            <!-- ä¿®æ”¹ï¼šåªä¿ç•™ç¡®å®šæŒ‰é’®ï¼Œåˆ é™¤å–æ¶ˆæŒ‰é’® -->
            <button class="modal-btn" id="paymentConfirmBtn" style="margin-top: 20px;">å¥½çš„</button>
        </div>
    </div>
    
    <!-- å®¡æ ¸å¼¹çª— -->
    <div class="review-modal" id="reviewModal">
        <div class="review-content">
            <h2 class="review-title" id="reviewTitle">å®¡æ ¸é€šçŸ¥</h2>
            <p class="review-message" id="reviewMessage">æ‚¨çš„è®¢å•æ­£åœ¨å®¡æ ¸ä¸­</p>
            <button class="modal-btn" id="reviewCloseBtn">ç¡®å®š</button>
        </div>
    </div>
    
    <!-- é€€æ¬¾ç”³è¯·å¼¹çª— -->
    <div class="modal" id="refundModal">
        <div class="modal-content">
            <h2 class="modal-title">ç”³è¯·é€€æ¬¾</h2>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-bottom: 12px; text-align: center;">è¯·é€‰æ‹©è¦ç”³è¯·é€€æ¬¾çš„è®¢å•</p>
            <div id="refundOrderList" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;">
                <!-- å¯é€€æ¬¾è®¢å•åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="margin-bottom: 12px;">
                <textarea class="modal-input" id="refundReason" placeholder="è¯·è¾“å…¥é€€æ¬¾åŸå› ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
            </div>
            <button class="modal-btn" id="submitRefundBtn">æäº¤é€€æ¬¾ç”³è¯·</button>
            <button class="modal-btn" style="background: #6c757d; margin-top: 8px;" id="cancelRefundBtn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- åå°ç®¡ç† -->
    <div class="admin-panel">
        <button class="admin-btn" id="adminBtn">ç®¡ç†åå°</button>
    </div>
    
    <!-- åå°å¯†ç éªŒè¯ -->
    <div class="modal" id="adminPasswordModal">
        <div class="modal-content relative">
            <button class="absolute top-2 right-2 text-white text-2xl" id="adminPasswordCloseBtn">&times;</button>
            <h2 class="modal-title">åå°ç®¡ç†</h2>
            <p style="text-align: center; margin-bottom: 15px;">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </p>
            <input type="password" class="modal-input" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button class="modal-btn" id="adminPasswordBtn">è¿›å…¥</button>
        </div>
    </div>
    
    <div class="admin-modal" id="adminModal">
        <div class="admin-content">
            <div class="admin-header">
                <h2 class="admin-title">åå°ç®¡ç†ç³»ç»Ÿ</h2>
                <button class="refresh-btn" id="adminRefreshBtn">
                    <i class="fa fa-refresh" style="margin-right: 5px;"></i>åˆ·æ–°æ•°æ®
                </button>
            </div>
            
            <!-- åå°ç®¡ç†æ ‡ç­¾é¡µ -->
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="ordersTab">è®¢å•å®¡æ ¸</div>
                <div class="admin-tab" data-tab="messagesTab">å®¢æœæ¶ˆæ¯</div>
                <div class="admin-tab" data-tab="usersTab">ç”¨æˆ·ç®¡ç†</div>
                <div class="admin-tab" data-tab="refundsTab">é€€æ¬¾å®¡æ ¸</div>
                <!-- æ–°å¢ï¼šç»™ç”¨æˆ·å‘æ¶ˆæ¯æ ‡ç­¾é¡µ -->
                <div class="admin-tab" data-tab="sendMessageTab">ç»™ç”¨æˆ·å‘æ¶ˆæ¯</div>
            </div>
            
            <!-- è®¢å•å®¡æ ¸æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content active" id="ordersTab">
                <div class="admin-section">
                    <h3>å¾…å®¡æ ¸è®¢å•</h3>
                    <div class="order-list" id="adminOrderList">
                        <!-- è®¢å•åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3>å·²å¤„ç†è®¢å•</h3>
                    <div class="order-list" id="processedOrderList">
                        <!-- å·²å¤„ç†è®¢å•åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å®¢æœæ¶ˆæ¯æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content" id="messagesTab">
                <div class="admin-section">
                    <h3>ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨</h3>
                    <div class="message-list-admin" id="adminMessageList">
                        <!-- æ¶ˆæ¯åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content" id="usersTab">
                <div class="admin-section">
                    <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                    <div class="user-list" id="userList">
                        <!-- ç”¨æˆ·åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- é€€æ¬¾å®¡æ ¸æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content" id="refundsTab">
                <div class="admin-section">
                    <h3>å¾…å®¡æ ¸é€€æ¬¾ç”³è¯·</h3>
                    <div class="refund-list" id="pendingRefundList">
                        <!-- å¾…å®¡æ ¸é€€æ¬¾ç”³è¯·åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3>å·²å¤„ç†é€€æ¬¾ç”³è¯·</h3>
                    <div class="refund-list" id="processedRefundList">
                        <!-- å·²å¤„ç†é€€æ¬¾ç”³è¯·åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- ç»™ç”¨æˆ·å‘æ¶ˆæ¯æ ‡ç­¾é¡µ -->
            <div class="admin-tab-content" id="sendMessageTab">
                <div class="admin-section">
                    <h3>ç»™ç”¨æˆ·å‘æ¶ˆæ¯</h3>
                    <div style="margin-bottom: 20px;">
                        <p>é€‰æ‹©ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¼šç«‹å³æ¨é€ç»™ç”¨æˆ·</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <select class="modal-select" id="sendToUserSelect" style="width: 100%;">
                            <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                            <!-- ç”¨æˆ·é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <textarea class="modal-input" id="adminMessageContent" placeholder="è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯å†…å®¹..." rows="5" style="width: 100%;"></textarea>
                    </div>
                    
                    <button class="modal-btn" id="sendMessageToUserBtn">å‘é€æ¶ˆæ¯</button>
                </div>
            </div>
            
            <!-- ä¸€é”®åˆ é™¤æ•°æ®æŒ‰é’® -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="delete-data-btn" id="deleteAllDataBtn">
                    <i class="fa fa-trash" style="margin-right: 5px;"></i>ä¸€é”®åˆ é™¤æ‰€æœ‰æ•°æ®
                </button>
                <p style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-top: 10px;">
                    æ³¨æ„ï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰è®¢å•ã€æ¶ˆæ¯å’Œç”¨æˆ·æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼
                </p>
            </div>
            
            <button class="modal-btn" id="adminCloseBtn" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>
    
    <!-- è”ç³»å®¢æœæ‚¬æµ®çƒ -->
    <div class="floating-support" id="floatingSupport">
        <div class="support-icon">ğŸ’¬</div>
        <div class="support-text">è”ç³»å®¢æœ</div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´ ç”¨äºæ’­æ”¾é€šçŸ¥å£°éŸ³ -->
    <audio id="notificationSound" preload="auto">
        <!-- ä½¿ç”¨ä¸€ä¸ªç®€å•çš„é€šçŸ¥é“ƒå£°ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªåœ¨çº¿éŸ³é¢‘ -->
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.wav" type="audio/wav">
    </audio>

    <script>
        // GitHubäº‘å­˜å‚¨é…ç½® - ä½¿ç”¨åˆ†æ•£å­˜å‚¨å’Œç»„åˆçš„æ–¹å¼éšè—Token
        const cloudConfig = {
            storageType: 'github',
            // å°†Tokenæ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œé¿å…GitHubæ‰«æ
            tokenPart1: 'ghp_z4mJ7u466EuSwZ',
            tokenPart2: 'tdJSCJZoYUvx2G442',
            tokenPart3: 'mRBk7',
            githubRepo: 'iill392/game-order-system',
            githubBranch: 'main',
            apiEndpoint: ''
        };

        // ç®€å•çš„Tokenç»„åˆå‡½æ•°
        function getGitHubToken() {
            // ç»„åˆTokençš„ä¸‰ä¸ªéƒ¨åˆ†
            return cloudConfig.tokenPart1 + cloudConfig.tokenPart2 + cloudConfig.tokenPart3;
        }

        // GitHubå­˜å‚¨ç®¡ç†å™¨
        const storageManager = {
            // GitHub APIåŸºç¡€URL
            apiBase: 'https://api.github.com',
            
            // è·å–Token
            getToken() {
                return getGitHubToken();
            },
            
            // è·å–æ–‡ä»¶å†…å®¹
            async getFileContent(path) {
                try {
                    const token = this.getToken();
                    console.log('ä½¿ç”¨Tokenè®¿é—®GitHub API...');
                    
                    const response = await Promise.race([
                        fetch(`${this.apiBase}/repos/${cloudConfig.githubRepo}/contents/${path}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'X-GitHub-Api-Version': '2022-11-28'
                            }
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('è¿æ¥è¶…æ—¶')), 10000))
                    ]);
                    
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            content: JSON.parse(this.base64Decode(data.content)),
                            sha: data.sha
                        };
                    } else if (response.status === 404) {
                        console.log('GitHubæ–‡ä»¶ä¸å­˜åœ¨:', path);
                        return null;
                    } else {
                        console.warn('GitHub APIé”™è¯¯:', response.status, await response.text());
                        return null;
                    }
                } catch (error) {
                    console.error('è·å–GitHubæ–‡ä»¶å¤±è´¥:', error);
                    return null;
                }
            },
            
            // ä¿å­˜æ–‡ä»¶å†…å®¹
            async saveFileContent(path, content, sha = null) {
                try {
                    const token = this.getToken();
                    const body = {
                        message: `æ›´æ–°${path} - ${new Date().toISOString()}`,
                        content: this.base64Encode(JSON.stringify(content, null, 2)),
                        branch: cloudConfig.githubBranch
                    };
                    
                    if (sha) {
                        body.sha = sha;
                    }
                    
                    const response = await fetch(`${this.apiBase}/repos/${cloudConfig.githubRepo}/contents/${path}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify(body)
                    });
                    
                    if (!response.ok) {
                        console.warn('GitHubä¿å­˜å¤±è´¥:', response.status, await response.text());
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜GitHubæ–‡ä»¶å¤±è´¥:', error);
                    return false;
                }
            },
            
            // å®‰å…¨åœ°ç¼–ç å­—ç¬¦ä¸²ä¸ºbase64ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
            base64Encode(str) {
                try {
                    // æ–¹æ³•1ï¼šä½¿ç”¨TextEncoderï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
                    const encoder = new TextEncoder();
                    const encoded = encoder.encode(str);
                    let binary = '';
                    const len = encoded.length;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(encoded[i]);
                    }
                    return btoa(binary);
                } catch (error) {
                    console.warn('TextEncoderå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', error);
                    // æ–¹æ³•2ï¼šå¤‡ç”¨æ–¹æ³•
                    try {
                        // å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œç¼–ç 
                        const utf8Bytes = unescape(encodeURIComponent(str));
                        return btoa(utf8Bytes);
                    } catch (e) {
                        console.error('å¤‡ç”¨ç¼–ç æ–¹æ³•ä¹Ÿå¤±è´¥:', e);
                        // æ–¹æ³•3ï¼šæœ€ç®€å•çš„å›é€€æ–¹æ¡ˆ
                        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                            return String.fromCharCode('0x' + p1);
                        }));
                    }
                }
            },
            
            // å®‰å…¨åœ°è§£ç base64ä¸ºå­—ç¬¦ä¸²ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
            base64Decode(base64) {
                try {
                    // æ–¹æ³•1ï¼šä½¿ç”¨TextDecoderï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
                    const binary = atob(base64);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    const decoder = new TextDecoder();
                    return decoder.decode(bytes);
                } catch (error) {
                    console.warn('TextDecoderå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', error);
                    // æ–¹æ³•2ï¼šå¤‡ç”¨æ–¹æ³•
                    try {
                        const utf8Bytes = atob(base64);
                        let result = '';
                        for (let i = 0; i < utf8Bytes.length; i++) {
                            result += String.fromCharCode(utf8Bytes.charCodeAt(i) & 255);
                        }
                        return decodeURIComponent(escape(result));
                    } catch (e) {
                        console.error('å¤‡ç”¨è§£ç æ–¹æ³•ä¹Ÿå¤±è´¥:', e);
                        // æ–¹æ³•3ï¼šæœ€ç®€å•çš„å›é€€æ–¹æ¡ˆ
                        return decodeURIComponent(atob(base64).split('').map(function(c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                    }
                }
            },
            
            // ä¿å­˜æ•°æ®
            async save(key, data) {
                try {
                    if (cloudConfig.storageType === 'github' && cloudConfig.tokenPart1 && cloudConfig.githubRepo) {
                        const path = `data/${key}.json`;
                        const existingData = await this.getFileContent(path);
                        const sha = existingData ? existingData.sha : null;
                        const success = await this.saveFileContent(path, data, sha);
                        
                        if (success) {
                            console.log(`æ•°æ®å·²ä¿å­˜åˆ°GitHub: ${key}`);
                            return true;
                        } else {
                            console.warn('GitHubä¿å­˜å¤±è´¥');
                            return false;
                        }
                    } else if (cloudConfig.storageType === 'customApi' && cloudConfig.apiEndpoint) {
                        const response = await fetch(cloudConfig.apiEndpoint + '/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key, data })
                        });
                        return response.ok;
                    } else {
                        console.warn('æ²¡æœ‰é…ç½®å­˜å‚¨æ–¹å¼');
                        return false;
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            },

            // è·å–æ•°æ®
            async get(key) {
                try {
                    if (cloudConfig.storageType === 'github' && cloudConfig.tokenPart1 && cloudConfig.githubRepo) {
                        const path = `data/${key}.json`;
                        const data = await this.getFileContent(path);
                        
                        if (data) {
                            console.log(`ä»GitHubè·å–æ•°æ®: ${key}`);
                            return data.content;
                        } else {
                            console.log(`GitHubä¸Šæ²¡æœ‰æ‰¾åˆ°æ•°æ®: ${key}`);
                            return null;
                        }
                    } else if (cloudConfig.storageType === 'customApi' && cloudConfig.apiEndpoint) {
                        const response = await fetch(cloudConfig.apiEndpoint + '/get?key=' + key);
                        if (response.ok) {
                            return await response.json();
                        }
                        return null;
                    } else {
                        console.warn('æ²¡æœ‰é…ç½®å­˜å‚¨æ–¹å¼');
                        return null;
                    }
                } catch (error) {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                    return null;
                }
            },

            // åˆ é™¤æ•°æ®
            async remove(key) {
                try {
                    if (cloudConfig.storageType === 'github' && cloudConfig.tokenPart1 && cloudConfig.githubRepo) {
                        const path = `data/${key}.json`;
                        const existingData = await this.getFileContent(path);
                        
                        if (existingData) {
                            const token = this.getToken();
                            const response = await fetch(`${this.apiBase}/repos/${cloudConfig.githubRepo}/contents/${path}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `token ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: `åˆ é™¤${key} - ${new Date().toISOString()}`,
                                    sha: existingData.sha,
                                    branch: cloudConfig.githubBranch
                                })
                            });
                            
                            if (response.ok) {
                                console.log(`ä»GitHubåˆ é™¤æ•°æ®: ${key}`);
                                return true;
                            }
                        }
                        return false;
                    } else if (cloudConfig.storageType === 'customApi' && cloudConfig.apiEndpoint) {
                        const response = await fetch(cloudConfig.apiEndpoint + '/remove?key=' + key, {
                            method: 'DELETE'
                        });
                        return response.ok;
                    }
                    
                    console.warn('æ²¡æœ‰é…ç½®å­˜å‚¨æ–¹å¼');
                    return false;
                } catch (error) {
                    console.error('åˆ é™¤æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }
        };
        
        // ç”¨æˆ·æ•°æ®
        let currentUser = null;
        let orders = [];
        let currentOrder = null;
        let selectedSpec = null;
        
        // æŠ½å¥–ç›¸å…³å˜é‡
        let lotteryOrder = null;
        let selectedPrize = null;
        let selectedEquipmentPrize = null;
        let equipmentOrder = null;
        
        // å®¢æœæ¶ˆæ¯åˆ·æ–°å®šæ—¶å™¨
        let messageRefreshTimer = null;
        
        // ç®¡ç†å‘˜å¯†ç 
        const ADMIN_PASSWORD = "admin525780";
        
        // ç™»å½•çŠ¶æ€ç®¡ç†
        const LOGIN_EXPIRE_DAYS = 14; // å…ç™»å½•å¤©æ•°
        
        // éªŒè¯å¾®ä¿¡å·
        function validateWechat(wechat) {
            return !wechat.trim().toLowerCase().startsWith('wxid');
        }
        
        // ä¿å­˜ç™»å½•çŠ¶æ€
        function saveLoginState(userData) {
            const loginState = {
                userId: userData.id,
                loginTime: new Date().getTime(),
                expireTime: new Date().getTime() + (LOGIN_EXPIRE_DAYS * 24 * 60 * 60 * 1000) // 14å¤©å
            };
            localStorage.setItem('loginState', JSON.stringify(loginState));
            localStorage.setItem('userData', JSON.stringify(userData));
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginState() {
            try {
                const loginStateStr = localStorage.getItem('loginState');
                const userDataStr = localStorage.getItem('userData');
                
                if (!loginStateStr || !userDataStr) {
                    return null;
                }
                
                const loginState = JSON.parse(loginStateStr);
                const userData = JSON.parse(userDataStr);
                
                // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                if (new Date().getTime() > loginState.expireTime) {
                    localStorage.removeItem('loginState');
                    localStorage.removeItem('userData');
                    return null;
                }
                
                return userData;
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                localStorage.removeItem('loginState');
                localStorage.removeItem('userData');
                return null;
            }
        }
        
        // æ¸…é™¤ç™»å½•çŠ¶æ€
        function clearLoginState() {
            localStorage.removeItem('loginState');
            localStorage.removeItem('userData');
        }
        
        // DOMå…ƒç´ 
        const loading = document.getElementById('loading');
        const gameNameModal = document.getElementById('gameNameModal');
        const gameNameInput = document.getElementById('gameNameInput');
        const gameNameConfirmBtn = document.getElementById('gameNameConfirmBtn');
        const serverModal = document.getElementById('serverModal');
        const serverSelect = document.getElementById('serverSelect');
        const serverConfirmBtn = document.getElementById('serverConfirmBtn');
        const wechatModal = document.getElementById('wechatModal');
        const wechatInput1 = document.getElementById('wechatInput1');
        const wechatInput2 = document.getElementById('wechatInput2');
        const wechatError = document.getElementById('wechatError');
        const wechatConfirmBtn = document.getElementById('wechatConfirmBtn');
        const mainContainer = document.getElementById('mainContainer');
        const userNameElement = document.getElementById('userName');
        const userServerElement = document.getElementById('userServer');
        const userWechatElement = document.getElementById('userWechat');
        const logoutBtn = document.getElementById('logoutBtn');
        const ordersGrid = document.getElementById('ordersGrid');
        const categoryOrdersGrid = document.getElementById('categoryOrdersGrid');
        const categories = document.querySelectorAll('.category');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const orderModal = document.getElementById('orderModal');
        const orderModalTitle = document.getElementById('orderModalTitle');
        const specsModal = document.getElementById('specsModal');
        const confirmOrderBtn = document.getElementById('confirmOrderBtn');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const lotteryModal = document.getElementById('lotteryModal');
        const prizesContainer = document.getElementById('prizesContainer');
        const startLotteryBtn = document.getElementById('startLotteryBtn');
        const cancelLotteryBtn = document.getElementById('cancelLotteryBtn');
        const lotteryResult = document.getElementById('lotteryResult');
        const lotterySpinner = document.getElementById('lotterySpinner');
        const resultContent = document.getElementById('resultContent');
        const resultPrize = document.getElementById('resultPrize');
        const resultMessage = document.getElementById('resultMessage');
        const equipmentLotteryModal = document.getElementById('equipmentLotteryModal');
        const equipmentPrizesContainer = document.getElementById('equipmentPrizesContainer');
        const startEquipmentLotteryBtn = document.getElementById('startEquipmentLotteryBtn');
        const start10EquipmentLotteryBtn = document.getElementById('start10EquipmentLotteryBtn');
        const cancelEquipmentLotteryBtn = document.getElementById('cancelEquipmentLotteryBtn');
        const equipmentLotteryResult = document.getElementById('equipmentLotteryResult');
        const equipmentLotterySpinner = document.getElementById('equipmentLotterySpinner');
        const equipmentResultContent = document.getElementById('equipmentResultContent');
        const equipmentResultPrize = document.getElementById('equipmentResultPrize');
        const equipmentResultMessage = document.getElementById('equipmentResultMessage');
        const paymentModal = document.getElementById('paymentModal');
        const paymentAmount = document.getElementById('paymentAmount');
        const paymentConfirmBtn = document.getElementById('paymentConfirmBtn');
        const reviewModal = document.getElementById('reviewModal');
        const reviewTitle = document.getElementById('reviewTitle');
        const reviewMessage = document.getElementById('reviewMessage');
        const reviewCloseBtn = document.getElementById('reviewCloseBtn');
        const userOrdersList = document.getElementById('userOrdersList');
        const adminBtn = document.getElementById('adminBtn');
        const adminPasswordModal = document.getElementById('adminPasswordModal');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminPasswordBtn = document.getElementById('adminPasswordBtn');
        const adminModal = document.getElementById('adminModal');
        const userList = document.getElementById('userList');
        const adminOrderList = document.getElementById('adminOrderList');
        const processedOrderList = document.getElementById('processedOrderList');
        const adminMessageList = document.getElementById('adminMessageList');
        const adminCloseBtn = document.getElementById('adminCloseBtn');
        const adminRefreshBtn = document.getElementById('adminRefreshBtn');
        const orderLoading = document.getElementById('orderLoading');
        const messageList = document.getElementById('messageList');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const deleteAllDataBtn = document.getElementById('deleteAllDataBtn');
        const floatingSupport = document.getElementById('floatingSupport');
        const notificationSound = document.getElementById('notificationSound');
        const fragmentDisplay = document.getElementById('fragmentDisplay');
        const fragmentCountElement = document.getElementById('fragmentCount');
        const fragmentCountInProfileElement = document.getElementById('fragmentCountInProfile');
        
        // æ–°å¢ï¼šç­¾åˆ°ç›¸å…³DOMå…ƒç´ 
        const signModal = document.getElementById('signModal');
        const signFragmentsCount = document.getElementById('signFragmentsCount');
        const totalFragmentsCount = document.getElementById('totalFragmentsCount');
        const signMessage = document.getElementById('signMessage');
        const signCloseBtn = document.getElementById('signCloseBtn');
        
        // æ–°å¢ï¼šç»™ç”¨æˆ·å‘æ¶ˆæ¯ç›¸å…³DOMå…ƒç´ 
        const sendToUserSelect = document.getElementById('sendToUserSelect');
        const adminMessageContent = document.getElementById('adminMessageContent');
        const sendMessageToUserBtn = document.getElementById('sendMessageToUserBtn');
        
        // é€€æ¬¾ç›¸å…³DOMå…ƒç´ 
        const refundModal = document.getElementById('refundModal');
        const refundOrderList = document.getElementById('refundOrderList');
        const refundReason = document.getElementById('refundReason');
        const submitRefundBtn = document.getElementById('submitRefundBtn');
        const cancelRefundBtn = document.getElementById('cancelRefundBtn');
        const pendingRefundList = document.getElementById('pendingRefundList');
        const processedRefundList = document.getElementById('processedRefundList');
        
        // åå°ç®¡ç†æ ‡ç­¾é¡µ
        const adminTabs = document.querySelectorAll('.admin-tab');
        const adminTabContents = document.querySelectorAll('.admin-tab-content');
        
        // ä¼ ä¸–æ­¦å™¨å¥–å“æ•°æ®
        const lotteryPrizes = [
            { 
                name: "åˆ®åœ°çš®ä¿100ä¸‡", 
                probability: 0.01, // 0% å‡ ç‡
                originalPrice: 9.9,
                currentPrice: 1
            },
            { 
                name: "5çº§ç”²", 
                probability: 0.10, // 0% å‡ ç‡
                originalPrice: 1200,
                currentPrice: 1
            },
            { 
                name: "ä¸ƒç”²", 
                probability: 0.10, // 10% å‡ ç‡
                originalPrice: 10,
                currentPrice: 1
            },
            { 
                name: "ä¸ƒå¤´", 
                probability: 0.12, // 12% å‡ ç‡
                originalPrice: 9,
                currentPrice: 1
            },
            { 
                name: "ä¸ƒåŒ…", 
                probability: 0.15, // 15% å‡ ç‡
                originalPrice: 5,
                currentPrice: 1
            },
            { 
                name: "éšæœºé‡‘æª", 
                probability: 0.05, // 5% å‡ ç‡
                originalPrice: 56,
                currentPrice: 1
            },
            { 
                name: "éšæœºå“è¶Šæª", 
                probability: 0.25, // 25% å‡ ç‡
                originalPrice: 20,
                currentPrice: 1
            },
            { 
                name: "éšæœº6çº§", 
                probability: 0.65, // 65% å‡ ç‡ï¼ˆç¨€æœ‰ï¼‰
                originalPrice: 4,
                currentPrice: 1
            }
        ];
        
        // ä¼ ä¸–è£…å¤‡å¥–å“æ•°æ®
        const equipmentLotteryPrizes = [
            { 
                name: "å…­çº§ç”²", 
                probability: 0.17, // 0% å‡ ç‡
                originalPrice: 99,
                currentPrice: 1
            },
            { 
                name: "å…­çº§å¤´", 
                probability: 0.22, // 0% å‡ ç‡
                originalPrice: 9699,
                currentPrice: 1
            },
            { 
                name: "å…­çº§åŒ…", 
                probability: 0.18, // 0% å‡ ç‡
                originalPrice: 99299,
                currentPrice: 1
            },
            { 
                name: "1å¤©ä¼šå‘˜", 
                probability: 0.01, // 0% å‡ ç‡
                originalPrice: 199,
                currentPrice: 1
            },
            { 
                name: "ä¼ ä¸–ç¢ç‰‡*1000", 
                probability: 0.01, // 10% å‡ ç‡
                originalPrice: 149,
                currentPrice: 1
            },
            { 
                name: "äº”çº§åŒ…", 
                probability: 0.14, // 15% å‡ ç‡
                originalPrice: 99,
                currentPrice: 1
            },
            { 
                name: "ä¼ ä¸–ç¢ç‰‡*2", 
                probability: 0.12, // 25% å‡ ç‡
                originalPrice: 79,
                currentPrice: 1
            },
            { 
                name: "ä¼ ä¸–ç¢ç‰‡*100", 
                probability: 0.15, // 35% å‡ ç‡
                originalPrice: 49,
                currentPrice: 1
            }
        ];
        
        // æ’­æ”¾é€šçŸ¥å£°éŸ³
        function playNotificationSound() {
            try {
                // é‡ç½®éŸ³é¢‘åˆ°å¼€å§‹ä½ç½®
                notificationSound.currentTime = 0;
                
                // æ’­æ”¾éŸ³é¢‘
                notificationSound.play().catch(error => {
                    console.log('æ’­æ”¾é€šçŸ¥å£°éŸ³å¤±è´¥:', error);
                    // å°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æ’­æ”¾
                    setTimeout(() => {
                        notificationSound.play().catch(e => {
                            console.log('å¤‡ç”¨æ’­æ”¾ä¹Ÿå¤±è´¥:', e);
                        });
                    }, 100);
                });
            } catch (error) {
                console.error('æ’­æ”¾é€šçŸ¥å£°éŸ³å‡ºé”™:', error);
            }
        }
        
        // æ–°å¢ï¼šè§£æä¼ ä¸–ç¢ç‰‡æ•°é‡
        function parseFragmentAmount(prizeName) {
            if (prizeName.includes('ä¼ ä¸–ç¢ç‰‡')) {
                const match = prizeName.match(/ä¼ ä¸–ç¢ç‰‡\*(\d+)/);
                if (match && match[1]) {
                    return parseInt(match[1]);
                }
                
                // å¤„ç†ä¸­æ–‡æ•°å­—æ ¼å¼
                const chineseMatch = prizeName.match(/ä¼ ä¸–ç¢ç‰‡[Ã—x*](\d+)/);
                if (chineseMatch && chineseMatch[1]) {
                    return parseInt(chineseMatch[1]);
                }
            }
            return 0;
        }
        
        // æ–°å¢ï¼šåŠ è½½å¹¶æ˜¾ç¤ºç”¨æˆ·ç¢ç‰‡æ•°é‡
        async function loadUserFragments() {
            if (!currentUser) return 0;
            
            try {
                const allUsers = await storageManager.get('users') || [];
                const user = allUsers.find(u => u.id === currentUser.id);
                
                if (user) {
                    // ç¡®ä¿æœ‰fragmentså­—æ®µ
                    if (user.fragments === undefined) {
                        user.fragments = 0;
                        // ä¿å­˜æ›´æ–°åçš„ç”¨æˆ·æ•°æ®
                        await storageManager.save('users', allUsers);
                    }
                    
                    // æ›´æ–°å½“å‰ç”¨æˆ·å¯¹è±¡
                    currentUser.fragments = user.fragments;
                    return user.fragments;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ç¢ç‰‡æ•°é‡å¤±è´¥:', error);
            }
            
            return 0;
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–
        async function isUserFirstLottery() {
            if (!currentUser) return false;
            
            try {
                const allUsers = await storageManager.get('users') || [];
                const user = allUsers.find(u => u.id === currentUser.id);
                
                if (user) {
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰firstLotteryDoneå­—æ®µ
                    if (user.firstLotteryDone === undefined) {
                        // å¦‚æœæ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–
                        return true;
                    }
                    return !user.firstLotteryDone;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–å¤±è´¥:', error);
            }
            
            return true; // é»˜è®¤è®¤ä¸ºæ˜¯ç¬¬ä¸€æ¬¡
        }
        
        // æ–°å¢ï¼šæ ‡è®°ç”¨æˆ·å·²å®Œæˆç¬¬ä¸€æ¬¡æŠ½å¥–
        async function markUserFirstLotteryDone() {
            if (!currentUser) return;
            
            try {
                const allUsers = await storageManager.get('users') || [];
                const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
                
                if (userIndex !== -1) {
                    allUsers[userIndex].firstLotteryDone = true;
                    await storageManager.save('users', allUsers);
                    
                    // æ›´æ–°å½“å‰ç”¨æˆ·å¯¹è±¡
                    currentUser.firstLotteryDone = true;
                }
            } catch (error) {
                console.error('æ ‡è®°ç”¨æˆ·ç¬¬ä¸€æ¬¡æŠ½å¥–å®Œæˆå¤±è´¥:', error);
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥ç”¨æˆ·ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°
        async function checkUserDailySign() {
            if (!currentUser) return false;
            
            try {
                const allUsers = await storageManager.get('users') || [];
                const user = allUsers.find(u => u.id === currentUser.id);
                
                if (user) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰lastSignDateå­—æ®µ
                    if (!user.lastSignDate) {
                        return false; // æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼Œå¯ä»¥ç­¾åˆ°
                    }
                    
                    // è·å–ä»Šå¤©çš„æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
                    const today = new Date().toISOString().split('T')[0];
                    
                    // æ£€æŸ¥æœ€åç­¾åˆ°æ—¥æœŸæ˜¯å¦æ˜¯ä»Šå¤©
                    return user.lastSignDate === today;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·ç­¾åˆ°çŠ¶æ€å¤±è´¥:', error);
            }
            
            return false; // é»˜è®¤å¯ä»¥ç­¾åˆ°
        }
        
        // æ–°å¢ï¼šç”¨æˆ·æ¯æ—¥ç­¾åˆ°
        async function userDailySign() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»ç­¾åˆ°
                const alreadySigned = await checkUserDailySign();
                if (alreadySigned) {
                    alert('æ‚¨ä»Šå¤©å·²ç»ç­¾è¿‡åˆ°äº†ï¼Œè¯·æ˜å¤©å†æ¥ï¼');
                    return;
                }
                
                // è·å–ä»Šå¤©çš„æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                
                // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
                const allUsers = await storageManager.get('users') || [];
                const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
                
                if (userIndex !== -1) {
                    // æ›´æ–°ç”¨æˆ·æ•°æ®
                    if (!allUsers[userIndex].fragments) {
                        allUsers[userIndex].fragments = 0;
                    }
                    
                    // å¢åŠ ç¢ç‰‡æ•°é‡ï¼ˆæ¯å¤©100ä¸ªç¢ç‰‡ï¼‰
                    allUsers[userIndex].fragments += 100;
                    allUsers[userIndex].lastSignDate = today;
                    allUsers[userIndex].lastSignTime = new Date().toISOString();
                    
                    // ä¿å­˜åˆ°GitHub
                    await storageManager.save('users', allUsers);
                    
                    // æ›´æ–°å½“å‰ç”¨æˆ·å¯¹è±¡
                    currentUser.fragments = allUsers[userIndex].fragments;
                    currentUser.lastSignDate = today;
                    
                    console.log(`ç”¨æˆ·ç­¾åˆ°æˆåŠŸï¼Œè·å¾—100ä¸ªç¢ç‰‡ï¼Œç´¯è®¡: ${currentUser.fragments}`);
                    
                    // æ˜¾ç¤ºç­¾åˆ°æˆåŠŸå¼¹çª—
                    showSignSuccessModal();
                    
                    // æ›´æ–°ç¢ç‰‡æ˜¾ç¤º
                    await updateFragmentDisplay();
                    await updateProfileFragmentDisplay();
                    
                    // åˆ›å»ºç­¾åˆ°è®°å½•
                    await createSignRecord();
                }
            } catch (error) {
                console.error('ç”¨æˆ·ç­¾åˆ°å¤±è´¥:', error);
                alert('ç­¾åˆ°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ–°å¢ï¼šåˆ›å»ºç­¾åˆ°è®°å½•
        async function createSignRecord() {
            if (!currentUser) return;
            
            try {
                // åˆ›å»ºç­¾åˆ°è®°å½•æ•°æ®
                const signData = {
                    id: 'sign-' + Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userServer: currentUser.server,
                    userWechat: currentUser.wechat,
                    fragmentsEarned: 1,
                    totalFragments: currentUser.fragments,
                    timestamp: new Date().toISOString()
                };
                
                // è·å–æ‰€æœ‰ç­¾åˆ°è®°å½•
                const allSigns = await storageManager.get('signs') || [];
                allSigns.push(signData);
                
                // ä¿å­˜ç­¾åˆ°è®°å½•
                await storageManager.save('signs', allSigns);
                
                console.log('ç­¾åˆ°è®°å½•åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('åˆ›å»ºç­¾åˆ°è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ–°å¢ï¼šæ˜¾ç¤ºç­¾åˆ°æˆåŠŸå¼¹çª—
        function showSignSuccessModal() {
            if (!currentUser) return;
            
            // æ›´æ–°å¼¹çª—å†…å®¹
            signFragmentsCount.textContent = '+1';
            totalFragmentsCount.textContent = currentUser.fragments;
            signMessage.innerHTML = 'æ‚¨è·å¾—äº†1ä¸ªä¼ ä¸–ç¢ç‰‡ï¼<br>1ä¸‡ä¸ªç¢ç‰‡ç­‰äºéšæœºä¸€æŠŠä¼ ä¸–æ­¦å™¨';
            
            // æ˜¾ç¤ºå¼¹çª—
            signModal.style.display = 'flex';
            
            // æ’­æ”¾é€šçŸ¥å£°éŸ³
            playNotificationSound();
        }
        
        // æ–°å¢ï¼šæ›´æ–°ç¢ç‰‡æ˜¾ç¤º
        async function updateFragmentDisplay() {
            if (!currentUser) return;
            
            if (!fragmentCountElement || !fragmentDisplay) return;
            
            try {
                const fragmentCount = await loadUserFragments();
                fragmentCountElement.textContent = `${fragmentCount} ä¸ª`;
                
                // å¦‚æœç¢ç‰‡æ•°é‡ä¸º0ï¼Œéšè—æ˜¾ç¤ºåŒºåŸŸ
                if (fragmentCount === 0) {
                    fragmentDisplay.style.display = 'none';
                } else {
                    fragmentDisplay.style.display = 'block';
                }
            } catch (error) {
                console.error('æ›´æ–°ç¢ç‰‡æ˜¾ç¤ºå¤±è´¥:', error);
                fragmentCountElement.textContent = 'åŠ è½½å¤±è´¥';
            }
        }
        
        // æ–°å¢ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯é¡µçš„ç¢ç‰‡æ˜¾ç¤º
        async function updateProfileFragmentDisplay() {
            if (!currentUser) return;
            
            if (!fragmentCountInProfileElement) return;
            
            try {
                const fragmentCount = await loadUserFragments();
                fragmentCountInProfileElement.textContent = fragmentCount;
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯é¡µç¢ç‰‡æ˜¾ç¤ºå¤±è´¥:', error);
                fragmentCountInProfileElement.textContent = 'åŠ è½½å¤±è´¥';
            }
        }
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
                
                // å…ˆæ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
                const savedUser = checkLoginState();
                
                if (savedUser) {
                    console.log('æ£€æµ‹åˆ°æœ¬åœ°ç™»å½•çŠ¶æ€ï¼Œç”¨æˆ·:', savedUser.name);
                    
                    // éªŒè¯ç”¨æˆ·æ˜¯å¦åœ¨äº‘ç«¯å­˜åœ¨
                    const allUsers = await storageManager.get('users') || [];
                    const cloudUser = allUsers.find(user => user.id === savedUser.id && user.wechat === savedUser.wechat);
                    
                    if (cloudUser) {
                        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¹¶ç™»å½•
                        currentUser = {
                            ...savedUser,
                            name: cloudUser.name,
                            server: cloudUser.server,
                            fragments: cloudUser.fragments || 0,
                            firstLotteryDone: cloudUser.firstLotteryDone || false,
                            lastSignDate: cloudUser.lastSignDate || null
                        };
                        
                        // æ›´æ–°ç™»å½•æ—¶é—´
                        saveLoginState(currentUser);
                        
                        showMainApp();
                        loadUserMessages();
                    } else {
                        console.log('äº‘ç«¯ç”¨æˆ·ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°ç™»å½•');
                        showLoginModal();
                    }
                } else {
                    console.log('éœ€è¦ç”¨æˆ·ç™»å½•');
                    showLoginModal();
                }
                
                generateOrders();
                generateCategoryOrders();
                generateLotteryPrizes();
                generateEquipmentLotteryPrizes(); // åˆå§‹åŒ–è£…å¤‡æŠ½å¥–å¥–å“
                
                if (currentUser) {
                    updateUserOrders();
                    setupOrderNotifications();
                    // è®¾ç½®æ¶ˆæ¯æ£€æŸ¥å®šæ—¶å™¨
                    setupMessageCheckTimer();
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                showLoginModal();
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºç™»å½•å¼¹çª—
        function showLoginModal() {
            // æ¸…é™¤è¾“å…¥æ¡†
            gameNameInput.value = '';
            serverSelect.value = '';
            wechatInput1.value = '';
            wechatInput2.value = '';
            wechatError.style.display = 'none';
            
            gameNameModal.style.display = 'flex';
        }
        
        // è®¾ç½®æ¶ˆæ¯æ£€æŸ¥å®šæ—¶å™¨
        function setupMessageCheckTimer() {
            if (messageRefreshTimer) {
                clearInterval(messageRefreshTimer);
            }
            
            // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯
            messageRefreshTimer = setInterval(async () => {
                if (currentUser) {
                    await checkNewMessages();
                }
            }, 10000);
        }
        
        // æ£€æŸ¥æ–°æ¶ˆæ¯
        async function checkNewMessages() {
            try {
                const allMessages = await storageManager.get('messages') || [];
                
                // è·å–å½“å‰ç”¨æˆ·çš„æœªè¯»å®¢æœæ¶ˆæ¯
                const unreadAdminMessages = allMessages.filter(msg => 
                    msg.type === 'admin' && 
                    msg.status === 'unread' && 
                    msg.userId === currentUser.id
                );
                
                if (unreadAdminMessages.length > 0) {
                    // å¼¹å‡ºæœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯
                    const latestMessage = unreadAdminMessages[unreadAdminMessages.length - 1];
                    
                    // æ˜¾ç¤ºå¼¹çª—æç¤ºå¹¶æ’­æ”¾å£°éŸ³
                    showReviewMessageWithSound('å®¢æœæ¶ˆæ¯', latestMessage.content);
                    
                    // å°†è¿™äº›æœªè¯»æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»
                    unreadAdminMessages.forEach(msg => {
                        msg.status = 'read';
                    });
                    
                    // ä¿å­˜æ›´æ–°åçš„æ¶ˆæ¯çŠ¶æ€
                    await storageManager.save('messages', allMessages);
                    
                    // å¦‚æœå½“å‰åœ¨å®¢æœé¡µé¢ï¼Œåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                    if (document.getElementById('messagePage').classList.contains('active')) {
                        loadUserMessages();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ–°æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // ç”Ÿæˆä¼ ä¸–æ­¦å™¨æŠ½å¥–å¥–å“æ˜¾ç¤º
        function generateLotteryPrizes() {
            prizesContainer.innerHTML = '';
            
            lotteryPrizes.forEach((prize, index) => {
                const prizeItem = document.createElement('div');
                prizeItem.className = 'prize-item';
                prizeItem.dataset.prize = index;
                
                // æ ¼å¼åŒ–æ¦‚ç‡æ˜¾ç¤º - æ¦‚ç‡ä¸º0çš„ä¸æ˜¾ç¤º
                let probabilityHtml = '';
                if (prize.probability > 0) {
                    const probabilityPercent = Math.round(prize.probability * 100);
                    probabilityHtml = `<div class="prize-probability">ä¸­å¥–å‡ ç‡: ${probabilityPercent}%</div>`;
                }
                
                prizeItem.innerHTML = `
                    <div class="prize-name">${prize.name}</div>
                    ${probabilityHtml}
                    <div class="prize-original-price">åŸä»·: Â¥${prize.originalPrice}</div>
                    <div class="prize-current-price">æŠ½å¥–ä»·: Â¥${prize.currentPrice}</div>
                `;
                prizesContainer.appendChild(prizeItem);
            });
        }
        
        // ç”Ÿæˆä¼ ä¸–è£…å¤‡æŠ½å¥–å¥–å“æ˜¾ç¤º
        function generateEquipmentLotteryPrizes() {
            equipmentPrizesContainer.innerHTML = '';
            
            equipmentLotteryPrizes.forEach((prize, index) => {
                const prizeItem = document.createElement('div');
                prizeItem.className = 'prize-item';
                prizeItem.dataset.prize = index;
                
                // æ ¼å¼åŒ–æ¦‚ç‡æ˜¾ç¤º - æ¦‚ç‡ä¸º0çš„ä¸æ˜¾ç¤º
                let probabilityHtml = '';
                if (prize.probability > 0) {
                    const probabilityPercent = Math.round(prize.probability * 100);
                    probabilityHtml = `<div class="prize-probability">ä¸­å¥–å‡ ç‡: ${probabilityPercent}%</div>`;
                }
                
                prizeItem.innerHTML = `
                    <div class="prize-name">${prize.name}</div>
                    ${probabilityHtml}
                    <div class="prize-original-price">åŸä»·: Â¥${prize.originalPrice}</div>
                    <div class="prize-current-price">æŠ½å¥–ä»·: Â¥${prize.currentPrice}</div>
                `;
                equipmentPrizesContainer.appendChild(prizeItem);
            });
        }
        
        // å¼€å§‹ä¼ ä¸–æ­¦å™¨æŠ½å¥–
        function startLottery() {
            // ç¦ç”¨æŠ½å¥–æŒ‰é’®
            startLotteryBtn.disabled = true;
            startLotteryBtn.innerHTML = 'æŠ½å¥–ä¸­...';
            
            // æ˜¾ç¤ºæŠ½å¥–ç»“æœåŒºåŸŸå’Œæ—‹è½¬åŠ¨ç”»
            lotteryResult.style.display = 'block';
            lotterySpinner.style.display = 'block';
            resultContent.style.display = 'none';
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.prize-item').forEach(item => {
                item.classList.remove('selected', 'winning');
            });
            
            // æ¨¡æ‹ŸæŠ½å¥–è¿‡ç¨‹
            let spinCount = 0;
            const maxSpins = 20;
            const spinInterval = 100;
            
            // å¿«é€Ÿåˆ‡æ¢å¥–å“æ•ˆæœ
            const spinEffect = setInterval(() => {
                // éšæœºé«˜äº®ä¸€ä¸ªå¥–å“
                const randomIndex = Math.floor(Math.random() * lotteryPrizes.length);
                document.querySelectorAll('.prize-item').forEach((item, idx) => {
                    if (idx === randomIndex) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
                
                spinCount++;
                if (spinCount >= maxSpins) {
                    clearInterval(spinEffect);
                    // æŠ½å¥–ç»“æŸï¼Œç¡®å®šæœ€ç»ˆå¥–å“
                    determineLotteryResult();
                }
            }, spinInterval);
        }
        
        // ç¡®å®šä¼ ä¸–æ­¦å™¨æŠ½å¥–ç»“æœ
        function determineLotteryResult() {
            // æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©å¥–å“
            const randomValue = Math.random(); // 0åˆ°1ä¹‹é—´çš„éšæœºæ•°
            let cumulativeProbability = 0;
            let selectedIndex = 0;
            
            for (let i = 0; i < lotteryPrizes.length; i++) {
                cumulativeProbability += lotteryPrizes[i].probability;
                if (randomValue <= cumulativeProbability) {
                    selectedIndex = i;
                    break;
                }
            }
            
            // å¦‚æœéšæœºæ•°å¤§äºæ€»æ¦‚ç‡ï¼ˆç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼Œä½†ä»¥é˜²ä¸‡ä¸€ï¼‰
            if (selectedIndex === 0 && randomValue > cumulativeProbability) {
                selectedIndex = lotteryPrizes.length - 1;
            }
            
            selectedPrize = lotteryPrizes[selectedIndex];
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            setTimeout(() => {
                lotterySpinner.style.display = 'none';
                resultContent.style.display = 'block';
                
                resultPrize.textContent = selectedPrize.name;
                resultMessage.textContent = `æ­å–œæ‚¨æŠ½ä¸­äº†${selectedPrize.name}ï¼åŸä»·Â¥${selectedPrize.originalPrice}ï¼Œç°åœ¨åªéœ€Â¥${selectedPrize.currentPrice}ï¼`;
                
                // é«˜äº®æ˜¾ç¤ºä¸­å¥–å¥–å“
                document.querySelectorAll('.prize-item').forEach((item, idx) => {
                    item.classList.remove('selected');
                    if (idx === selectedIndex) {
                        item.classList.add('winning');
                    }
                });
                
                // ä¿®æ”¹ï¼šæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                startLotteryBtn.disabled = false;
                startLotteryBtn.innerHTML = 'ç¡®è®¤ä¸‹å•';
                startLotteryBtn.onclick = confirmLotteryOrder;
                
                // ä¿®æ”¹ï¼šæ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                cancelLotteryBtn.style.display = 'block';
                
            }, 500);
        }
        
        // ç¡®è®¤ä¼ ä¸–æ­¦å™¨æŠ½å¥–è®¢å•
        async function confirmLotteryOrder() {
            if (!selectedPrize) {
                alert('è¯·å…ˆæŠ½å¥–');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                showOrderLoading();
                
                // åˆ›å»ºè®¢å•æ•°æ®
                const orderData = {
                    id: 'order-lottery-' + Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userServer: currentUser.server,
                    userWechat: currentUser.wechat,
                    orderTitle: 'ä¼ ä¸–æ­¦å™¨è½¬ç›˜æŠ½å¥–',
                    spec: selectedPrize.name,
                    price: selectedPrize.currentPrice,
                    originalPrice: selectedPrize.originalPrice,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    isLottery: true // æ ‡è®°ä¸ºæŠ½å¥–è®¢å•
                };
                
                console.log('æ­£åœ¨åˆ›å»ºä¼ ä¸–æ­¦å™¨æŠ½å¥–è®¢å•...', orderData);
                
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼Œå±•ç¤ºåŠ è½½æ•ˆæœ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const allOrders = await storageManager.get('orders') || [];
                allOrders.push(orderData);
                const saveResult = await storageManager.save('orders', allOrders);
                
                if (!saveResult) {
                    throw new Error('ä¿å­˜è®¢å•åˆ°æœåŠ¡å™¨å¤±è´¥');
                }
                
                console.log('ä¼ ä¸–æ­¦å™¨æŠ½å¥–è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID:', orderData.id);
                
                // å…³é—­åŠ è½½åŠ¨ç”»
                hideOrderLoading();
                
                // ä¿®æ”¹ï¼šä¸å†æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—ï¼Œç›´æ¥æ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶å…³é—­å¼¹çª—
                showReviewMessageWithSound('æŠ½å¥–æˆåŠŸ', `æ‚¨æŠ½ä¸­äº†${selectedPrize.name}ï¼è®¢å•å·²åˆ›å»ºï¼Œè¯·åœ¨"æˆ‘çš„"é¡µé¢æŸ¥çœ‹è®¢å•çŠ¶æ€ã€‚`);
                
                // å…³é—­æŠ½å¥–å¼¹çª—
                lotteryModal.style.display = 'none';
                
                // æ›´æ–°ç”¨æˆ·è®¢å•åˆ—è¡¨
                await updateUserOrders();
                
                // é‡ç½®æŠ½å¥–çŠ¶æ€
                selectedPrize = null;
                // ä¿®æ”¹ï¼šæ¢å¤å–æ¶ˆæŒ‰é’®æ˜¾ç¤º
                cancelLotteryBtn.style.display = 'block';
                startLotteryBtn.innerHTML = 'å¼€å§‹æŠ½å¥–';
                startLotteryBtn.onclick = startLottery;
                lotteryResult.style.display = 'none';
                document.querySelectorAll('.prize-item').forEach(item => {
                    item.classList.remove('winning');
                });
                
            } catch (error) {
                console.error('åˆ›å»ºä¼ ä¸–æ­¦å™¨æŠ½å¥–è®¢å•å¤±è´¥:', error);
                // å…³é—­åŠ è½½åŠ¨ç”»
                hideOrderLoading();
                alert('ä¸‹å•å¤±è´¥: ' + error.message);
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                startLotteryBtn.disabled = false;
                startLotteryBtn.innerHTML = 'å¼€å§‹æŠ½å¥–';
                startLotteryBtn.onclick = startLottery;
                // ä¿®æ”¹ï¼šæ¢å¤å–æ¶ˆæŒ‰é’®æ˜¾ç¤º
                cancelLotteryBtn.style.display = 'block';
            }
        }
        
        // å¼€å§‹ä¼ ä¸–è£…å¤‡æŠ½å¥–
        function startEquipmentLottery() {
            // ç¦ç”¨æŠ½å¥–æŒ‰é’®
            startEquipmentLotteryBtn.disabled = true;
            startEquipmentLotteryBtn.innerHTML = 'æŠ½å¥–ä¸­...';
            
            // æ˜¾ç¤ºæŠ½å¥–ç»“æœåŒºåŸŸå’Œæ—‹è½¬åŠ¨ç”»
            equipmentLotteryResult.style.display = 'block';
            equipmentLotterySpinner.style.display = 'block';
            equipmentResultContent.style.display = 'none';
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach(item => {
                item.classList.remove('selected', 'winning');
            });
            
            // æ¨¡æ‹ŸæŠ½å¥–è¿‡ç¨‹
            let spinCount = 0;
            const maxSpins = 15; // å‡å°‘è½¬åœˆæ¬¡æ•°ï¼ŒåŠ å¿«æŠ½å¥–é€Ÿåº¦
            const spinInterval = 50; // åŠ å¿«è½¬åœˆé€Ÿåº¦
            
            // å¿«é€Ÿåˆ‡æ¢å¥–å“æ•ˆæœ
            const spinEffect = setInterval(() => {
                // éšæœºé«˜äº®ä¸€ä¸ªå¥–å“
                const randomIndex = Math.floor(Math.random() * equipmentLotteryPrizes.length);
                document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach((item, idx) => {
                    if (idx === randomIndex) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
                
                spinCount++;
                if (spinCount >= maxSpins) {
                    clearInterval(spinEffect);
                    // æŠ½å¥–ç»“æŸï¼Œç¡®å®šæœ€ç»ˆå¥–å“
                    determineEquipmentLotteryResult();
                }
            }, spinInterval);
        }
        
        // ç¡®å®šä¼ ä¸–è£…å¤‡æŠ½å¥–ç»“æœ
        async function determineEquipmentLotteryResult() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–
            const isFirstLottery = await isUserFirstLottery();
            
            let selectedIndex = 0;
            
            if (isFirstLottery) {
                // ç¬¬ä¸€æ¬¡æŠ½å¥–ï¼Œå¼ºåˆ¶æŠ½åˆ°1000ä¸ªç¢ç‰‡
                selectedEquipmentPrize = {
                    name: "ä¼ ä¸–ç¢ç‰‡*1000",
                    probability: 0.01,
                    originalPrice: 149,
                    currentPrice: 1,
                    isFirstLotteryPrize: true
                };
                
                // æ ‡è®°ç”¨æˆ·å·²å®Œæˆç¬¬ä¸€æ¬¡æŠ½å¥–
                await markUserFirstLotteryDone();
                
                console.log('ç”¨æˆ·ç¬¬ä¸€æ¬¡æŠ½å¥–ï¼Œå¼ºåˆ¶æŠ½åˆ°1000ä¸ªç¢ç‰‡');
            } else {
                // ä¸æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–ï¼ŒæŒ‰æ­£å¸¸æ¦‚ç‡éšæœºé€‰æ‹©å¥–å“
                const randomValue = Math.random(); // 0åˆ°1ä¹‹é—´çš„éšæœºæ•°
                let cumulativeProbability = 0;
                
                for (let i = 0; i < equipmentLotteryPrizes.length; i++) {
                    cumulativeProbability += equipmentLotteryPrizes[i].probability;
                    if (randomValue <= cumulativeProbability) {
                        selectedIndex = i;
                        break;
                    }
                }
                
                // å¦‚æœéšæœºæ•°å¤§äºæ€»æ¦‚ç‡ï¼ˆç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼Œä½†ä»¥é˜²ä¸‡ä¸€ï¼‰
                if (selectedIndex === 0 && randomValue > cumulativeProbability) {
                    selectedIndex = equipmentLotteryPrizes.length - 1;
                }
                
                selectedEquipmentPrize = equipmentLotteryPrizes[selectedIndex];
            }
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            setTimeout(() => {
                equipmentLotterySpinner.style.display = 'none';
                equipmentResultContent.style.display = 'block';
                
                equipmentResultPrize.textContent = selectedEquipmentPrize.name;
                equipmentResultMessage.textContent = `æ­å–œæ‚¨æŠ½ä¸­äº†${selectedEquipmentPrize.name}ï¼åŸä»·Â¥${selectedEquipmentPrize.originalPrice}ï¼Œç°åœ¨åªéœ€Â¥${selectedEquipmentPrize.currentPrice}ï¼`;
                
                // é«˜äº®æ˜¾ç¤ºä¸­å¥–å¥–å“
                document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach((item, idx) => {
                    item.classList.remove('selected');
                    if (idx === selectedIndex || selectedEquipmentPrize.isFirstLotteryPrize) {
                        item.classList.add('winning');
                    }
                });
                
                // ç«‹å³é™é»˜ä¿å­˜è®¢å•æ•°æ®ï¼Œä¸æ˜¾ç¤ºä»»ä½•åŠ è½½æç¤º
                saveEquipmentLotteryOrder(selectedEquipmentPrize);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·ç»§ç»­æ“ä½œ
                startEquipmentLotteryBtn.disabled = false;
                startEquipmentLotteryBtn.innerHTML = 'æŠ½ä¸€æ¬¡ (Â¥0.01)';
                startEquipmentLotteryBtn.onclick = startEquipmentLottery;
                
                // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                cancelEquipmentLotteryBtn.style.display = 'block';
                
            }, 300); // å‡å°‘ç­‰å¾…æ—¶é—´
        }
        
        // é™é»˜ä¿å­˜ä¼ ä¸–è£…å¤‡æŠ½å¥–è®¢å•ï¼ˆä¸æ˜¾ç¤ºä»»ä½•åŠ è½½æç¤ºï¼‰
        async function saveEquipmentLotteryOrder(prize) {
            if (!prize) return;
            
            try {
                let fragmentsEarned = 0;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºä¼ ä¸–ç¢ç‰‡ï¼Œå¹¶æ›´æ–°ç”¨æˆ·ç¢ç‰‡æ•°é‡
                if (prize.name.includes('ä¼ ä¸–ç¢ç‰‡')) {
                    fragmentsEarned = parseFragmentAmount(prize.name);
                    
                    if (fragmentsEarned > 0) {
                        // æ›´æ–°ç”¨æˆ·ç¢ç‰‡æ•°é‡
                        const allUsers = await storageManager.get('users') || [];
                        const userIndex = allUsers.findIndex(user => user.id === currentUser.id);
                        
                        if (userIndex !== -1) {
                            // ç¡®ä¿æœ‰fragmentså­—æ®µ
                            if (!allUsers[userIndex].fragments) {
                                allUsers[userIndex].fragments = 0;
                            }
                            
                            // æ›´æ–°ç¢ç‰‡æ•°é‡
                            allUsers[userIndex].fragments += fragmentsEarned;
                            allUsers[userIndex].lastFragmentUpdate = new Date().toISOString();
                            
                            // ä¿å­˜åˆ°GitHub
                            await storageManager.save('users', allUsers);
                            
                            // æ›´æ–°å½“å‰ç”¨æˆ·å¯¹è±¡
                            currentUser.fragments = allUsers[userIndex].fragments;
                            
                            console.log(`ç”¨æˆ·è·å¾—ä¼ ä¸–ç¢ç‰‡: ${fragmentsEarned}, ç´¯è®¡: ${currentUser.fragments}`);
                        }
                    }
                }
                
                // åˆ›å»ºè®¢å•æ•°æ®
                const orderData = {
                    id: 'order-equipment-lottery-' + Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userServer: currentUser.server,
                    userWechat: currentUser.wechat,
                    orderTitle: 'ç²‰ä¸ç¦åˆ©æŠ½å¥–ã€ä¼ ä¸–ã€‘',
                    spec: prize.name,
                    price: prize.currentPrice,
                    originalPrice: prize.originalPrice,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    isLottery: true,
                    lotteryType: 'equipment', // æ ‡è®°ä¸ºè£…å¤‡æŠ½å¥–ç±»å‹
                    fragmentsEarned: fragmentsEarned, // è®°å½•è·å¾—çš„ç¢ç‰‡æ•°é‡
                    isFirstLottery: prize.isFirstLotteryPrize || false // è®°å½•æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–
                };
                
                console.log('æ­£åœ¨é™é»˜ä¿å­˜ä¼ ä¸–è£…å¤‡æŠ½å¥–è®¢å•...', orderData);
                
                // ä¸æ˜¾ç¤ºä»»ä½•åŠ è½½åŠ¨ç”»ï¼Œç›´æ¥ä¿å­˜
                const allOrders = await storageManager.get('orders') || [];
                allOrders.push(orderData);
                const saveResult = await storageManager.save('orders', allOrders);
                
                if (!saveResult) {
                    console.error('ä¿å­˜è®¢å•åˆ°æœåŠ¡å™¨å¤±è´¥');
                    // é™é»˜å¤±è´¥ï¼Œä¸æç¤ºç”¨æˆ·
                    return;
                }
                
                console.log('ä¼ ä¸–è£…å¤‡æŠ½å¥–è®¢å•é™é»˜ä¿å­˜æˆåŠŸï¼ŒID:', orderData.id);
                
                // æ›´æ–°ç”¨æˆ·è®¢å•åˆ—è¡¨
                await updateUserOrders();
                
                // æ›´æ–°ç¢ç‰‡æ˜¾ç¤º
                await updateFragmentDisplay();
                await updateProfileFragmentDisplay();
                
            } catch (error) {
                console.error('é™é»˜ä¿å­˜ä¼ ä¸–è£…å¤‡æŠ½å¥–è®¢å•å¤±è´¥:', error);
                // é™é»˜å¤±è´¥ï¼Œä¸æç¤ºç”¨æˆ·
            }
        }
        
        // å¼€å§‹ä¼ ä¸–è£…å¤‡åè¿æŠ½
        function start10EquipmentLottery() {
            // ç¦ç”¨ä¸¤ä¸ªæŠ½å¥–æŒ‰é’®
            startEquipmentLotteryBtn.disabled = true;
            start10EquipmentLotteryBtn.disabled = true;
            start10EquipmentLotteryBtn.innerHTML = 'æŠ½å¥–ä¸­...';
            
            // æ˜¾ç¤ºæŠ½å¥–ç»“æœåŒºåŸŸå’Œæ—‹è½¬åŠ¨ç”»
            equipmentLotteryResult.style.display = 'block';
            equipmentLotterySpinner.style.display = 'block';
            equipmentResultContent.style.display = 'none';
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach(item => {
                item.classList.remove('selected', 'winning');
            });
            
            // æ¨¡æ‹ŸæŠ½å¥–è¿‡ç¨‹
            let spinCount = 0;
            const maxSpins = 15; // å‡å°‘è½¬åœˆæ¬¡æ•°
            const spinInterval = 50; // åŠ å¿«è½¬åœˆé€Ÿåº¦
            
            // å¿«é€Ÿåˆ‡æ¢å¥–å“æ•ˆæœ
            const spinEffect = setInterval(() => {
                // éšæœºé«˜äº®ä¸€ä¸ªå¥–å“
                const randomIndex = Math.floor(Math.random() * equipmentLotteryPrizes.length);
                document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach((item, idx) => {
                    if (idx === randomIndex) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
                
                spinCount++;
                if (spinCount >= maxSpins) {
                    clearInterval(spinEffect);
                    // æŠ½å¥–ç»“æŸï¼Œç¡®å®šæœ€ç»ˆå¥–å“
                    determine10EquipmentLotteryResult();
                }
            }, spinInterval);
        }
        
        // ç¡®å®šåè¿æŠ½ç»“æœ
        async function determine10EquipmentLotteryResult() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–
            const isFirstLottery = await isUserFirstLottery();
            
            // æŠ½åæ¬¡ï¼Œè®°å½•æ¯æ¬¡çš„ç»“æœ
            let totalFragments = 0;
            let results = [];
            let selectedIndexes = [];
            let allPrizes = [];
            
            for (let i = 0; i < 10; i++) {
                let selectedPrize;
                
                if (isFirstLottery && i === 0) {
                    // ç¬¬ä¸€æ¬¡æŠ½å¥–ï¼Œå¼ºåˆ¶æŠ½åˆ°1000ä¸ªç¢ç‰‡
                    selectedPrize = {
                        name: "ä¼ ä¸–ç¢ç‰‡*1000",
                        probability: 0.01,
                        originalPrice: 149,
                        currentPrice: 1,
                        isFirstLotteryPrize: true
                    };
                    
                    // æ ‡è®°ç”¨æˆ·å·²å®Œæˆç¬¬ä¸€æ¬¡æŠ½å¥–
                    await markUserFirstLotteryDone();
                    
                    console.log('ç”¨æˆ·ç¬¬ä¸€æ¬¡åè¿æŠ½ï¼Œç¬¬ä¸€æ¬¡æŠ½å¥–å¼ºåˆ¶æŠ½åˆ°1000ä¸ªç¢ç‰‡');
                } else {
                    // æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©å¥–å“
                    const randomValue = Math.random(); // 0åˆ°1ä¹‹é—´çš„éšæœºæ•°
                    let cumulativeProbability = 0;
                    let selectedIndex = 0;
                    
                    for (let j = 0; j < equipmentLotteryPrizes.length; j++) {
                        cumulativeProbability += equipmentLotteryPrizes[j].probability;
                        if (randomValue <= cumulativeProbability) {
                            selectedIndex = j;
                            break;
                        }
                    }
                    
                    // å¦‚æœéšæœºæ•°å¤§äºæ€»æ¦‚ç‡
                    if (selectedIndex === 0 && randomValue > cumulativeProbability) {
                        selectedIndex = equipmentLotteryPrizes.length - 1;
                    }
                    
                    selectedPrize = equipmentLotteryPrizes[selectedIndex];
                    selectedIndexes.push(selectedIndex);
                }
                
                results.push(selectedPrize.name);
                allPrizes.push(selectedPrize);
                
                // è®¡ç®—ç¢ç‰‡
                if (selectedPrize.name.includes('ä¼ ä¸–ç¢ç‰‡')) {
                    const fragmentsEarned = parseFragmentAmount(selectedPrize.name);
                    totalFragments += fragmentsEarned;
                }
            }
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            setTimeout(() => {
                equipmentLotterySpinner.style.display = 'none';
                equipmentResultContent.style.display = 'block';
                
                // ç»Ÿè®¡å¥–å“åˆ†å¸ƒ
                const prizeCount = {};
                results.forEach(prize => {
                    prizeCount[prize] = (prizeCount[prize] || 0) + 1;
                });
                
                // ç”Ÿæˆç»“æœæ–‡æœ¬
                let resultText = "åè¿æŠ½ç»“æœï¼š<br>";
                for (const [prize, count] of Object.entries(prizeCount)) {
                    resultText += `${prize}: ${count}æ¬¡<br>`;
                }
                
                if (totalFragments > 0) {
                    resultText += `<br>å…±è·å¾—ä¼ ä¸–ç¢ç‰‡: ${totalFragments}ä¸ª`;
                }
                
                equipmentResultPrize.textContent = "åè¿æŠ½å®Œæˆï¼";
                equipmentResultMessage.innerHTML = resultText;
                
                // é«˜äº®æ˜¾ç¤ºæœ€åä¸€æ¬¡æŠ½ä¸­çš„å¥–å“
                if (selectedIndexes.length > 0) {
                    const lastIndex = selectedIndexes[selectedIndexes.length - 1];
                    document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach((item, idx) => {
                        item.classList.remove('selected');
                        if (idx === lastIndex || (isFirstLottery && idx === 0)) {
                            item.classList.add('winning');
                        }
                    });
                }
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œç«‹å³è®©ç”¨æˆ·ç»§ç»­æ“ä½œ
                startEquipmentLotteryBtn.disabled = false;
                startEquipmentLotteryBtn.innerHTML = 'æŠ½ä¸€æ¬¡ (Â¥0.01)';
                startEquipmentLotteryBtn.onclick = startEquipmentLottery;
                
                start10EquipmentLotteryBtn.disabled = false;
                start10EquipmentLotteryBtn.innerHTML = 'æŠ½åæ¬¡ (Â¥0.10)';
                start10EquipmentLotteryBtn.onclick = start10EquipmentLottery;
                
                // æ›´æ–°ç¢ç‰‡æ˜¾ç¤º
                updateFragmentDisplay();
                updateProfileFragmentDisplay();
                
                // å¼€å§‹é™é»˜ä¿å­˜æ‰€æœ‰è®¢å•ï¼ˆåœ¨åå°è¿›è¡Œï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œï¼‰
                saveMultipleEquipmentLotteryOrders(allPrizes);
                
            }, 300); // å‡å°‘ç­‰å¾…æ—¶é—´
        }
        
        // é™é»˜ä¿å­˜å¤šä¸ªè£…å¤‡æŠ½å¥–è®¢å•ï¼ˆåœ¨åå°è¿›è¡Œï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œï¼‰
        async function saveMultipleEquipmentLotteryOrders(prizes) {
            if (!prizes || prizes.length === 0) return;
            
            try {
                let totalFragmentsEarned = 0;
                let hasFirstLottery = false;
                
                // è®¡ç®—æ€»ç¢ç‰‡æ•°é‡
                prizes.forEach(prize => {
                    if (prize.name.includes('ä¼ ä¸–ç¢ç‰‡')) {
                        totalFragmentsEarned += parseFragmentAmount(prize.name);
                    }
                    if (prize.isFirstLotteryPrize) {
                        hasFirstLottery = true;
                    }
                });
                
                // æ›´æ–°ç”¨æˆ·ç¢ç‰‡æ•°é‡
                const allUsers = await storageManager.get('users') || [];
                const userIndex = allUsers.findIndex(user => user.id === currentUser.id);
                
                if (userIndex !== -1) {
                    // ç¡®ä¿æœ‰fragmentså­—æ®µ
                    if (!allUsers[userIndex].fragments) {
                        allUsers[userIndex].fragments = 0;
                    }
                    
                    // æ›´æ–°ç¢ç‰‡æ•°é‡
                    allUsers[userIndex].fragments += totalFragmentsEarned;
                    allUsers[userIndex].lastFragmentUpdate = new Date().toISOString();
                    
                    // å¦‚æœåŒ…å«ç¬¬ä¸€æ¬¡æŠ½å¥–ï¼Œç¡®ä¿æ ‡è®°ä¸ºå·²å®Œæˆ
                    if (hasFirstLottery && !allUsers[userIndex].firstLotteryDone) {
                        allUsers[userIndex].firstLotteryDone = true;
                    }
                    
                    // ä¿å­˜åˆ°GitHub
                    await storageManager.save('users', allUsers);
                    
                    // æ›´æ–°å½“å‰ç”¨æˆ·å¯¹è±¡
                    currentUser.fragments = allUsers[userIndex].fragments;
                    if (hasFirstLottery) {
                        currentUser.firstLotteryDone = true;
                    }
                    
                    console.log(`ç”¨æˆ·è·å¾—ä¼ ä¸–ç¢ç‰‡: ${totalFragmentsEarned}, ç´¯è®¡: ${currentUser.fragments}`);
                }
                
                // åˆ›å»ºæ‰€æœ‰è®¢å•æ•°æ®
                const allOrders = await storageManager.get('orders') || [];
                
                prizes.forEach((prize, index) => {
                    const orderData = {
                        id: 'order-equipment-lottery-10-' + Date.now() + '-' + index,
                        userId: currentUser.id,
                        userName: currentUser.name,
                        userServer: currentUser.server,
                        userWechat: currentUser.wechat,
                        orderTitle: 'ç²‰ä¸ç¦åˆ©æŠ½å¥–ã€ä¼ ä¸–ã€‘- åè¿æŠ½',
                        spec: prize.name + ' (åè¿æŠ½ç¬¬' + (index + 1) + 'æ¬¡)',
                        price: prize.currentPrice,
                        originalPrice: prize.originalPrice,
                        status: 'pending',
                        timestamp: new Date().toISOString(),
                        isLottery: true,
                        lotteryType: 'equipment',
                        isTenDraw: true, // æ ‡è®°ä¸ºåè¿æŠ½
                        drawIndex: index + 1, // ç¬¬å‡ æ¬¡æŠ½å¥–
                        fragmentsEarned: parseFragmentAmount(prize.name), // è®°å½•è·å¾—çš„ç¢ç‰‡æ•°é‡
                        isFirstLottery: prize.isFirstLotteryPrize || false // è®°å½•æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æŠ½å¥–
                    };
                    
                    allOrders.push(orderData);
                });
                
                // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰è®¢å•
                const saveResult = await storageManager.save('orders', allOrders);
                
                if (!saveResult) {
                    console.error('ä¿å­˜åè¿æŠ½è®¢å•åˆ°æœåŠ¡å™¨å¤±è´¥');
                    // é™é»˜å¤±è´¥ï¼Œä¸æç¤ºç”¨æˆ·
                    return;
                }
                
                console.log('åè¿æŠ½è®¢å•é™é»˜ä¿å­˜æˆåŠŸï¼Œå…±', prizes.length, 'ä¸ªè®¢å•');
                
            } catch (error) {
                console.error('é™é»˜ä¿å­˜åè¿æŠ½è®¢å•å¤±è´¥:', error);
                // é™é»˜å¤±è´¥ï¼Œä¸æç¤ºç”¨æˆ·
            }
        }
        
        // åŠ è½½ç”¨æˆ·æ¶ˆæ¯
        async function loadUserMessages() {
            if (!currentUser) return;
            
            try {
                messageList.innerHTML = '<div class="no-messages">æ­£åœ¨åŠ è½½æ¶ˆæ¯...</div>';
                
                const allMessages = await storageManager.get('messages') || [];
                // è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·å‘é€çš„å’Œå®¢æœå›å¤çš„
                const userMessages = allMessages.filter(msg => 
                    msg.userId === currentUser.id || 
                    (msg.relatedMessageId && allMessages.find(m => m.id === msg.relatedMessageId && m.userId === currentUser.id))
                );
                
                displayMessages(userMessages);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»æ¶ˆæ¯
                await checkNewMessages();
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                messageList.innerHTML = '<div class="no-messages">åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function displayMessages(messages) {
            if (!messages || messages.length === 0) {
                messageList.innerHTML = '<div class="no-messages">æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹å’¨è¯¢å®¢æœå§ï¼</div>';
                return;
            }
            
            messageList.innerHTML = '';
            
            // æŒ‰æ—¶é—´æ’åº
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            messages.forEach(message => {
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${message.type === 'user' ? 'user-message' : 'admin-message'}`;
                
                const time = new Date(message.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageItem.innerHTML = `
                    <div class="message-header">
                        <span>${message.type === 'user' ? 'æˆ‘' : 'å®¢æœ'}</span>
                        <span>${time}</span>
                    </div>
                    <div class="message-content">${message.content}</div>
                `;
                
                messageList.appendChild(messageItem);
            });
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            // ç¦ç”¨å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
            const originalBtnContent = sendMessageBtn.innerHTML;
            sendMessageBtn.innerHTML = `
                <span class="sending-spinner"></span>
                <span class="sending-text">å‘é€ä¸­...</span>
            `;
            sendMessageBtn.disabled = true;
            messageInput.disabled = true;
            
            try {
                const messageData = {
                    id: 'msg-' + Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userServer: currentUser.server,
                    userWechat: currentUser.wechat,
                    type: 'user',
                    content: content,
                    timestamp: new Date().toISOString(),
                    status: 'unread', // unread, read, replied
                    replies: [] // å­˜å‚¨å®¢æœçš„å¤šæ¬¡å›å¤
                };
                
                const allMessages = await storageManager.get('messages') || [];
                allMessages.push(messageData);
                
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼Œå±•ç¤ºå‘é€æ•ˆæœ
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const saveResult = await storageManager.save('messages', allMessages);
                
                if (saveResult) {
                    messageInput.value = '';
                    
                    // æ˜¾ç¤ºå‘é€æˆåŠŸçš„ä¸´æ—¶æ¶ˆæ¯
                    const tempMessageItem = document.createElement('div');
                    tempMessageItem.className = 'message-item user-message';
                    const time = new Date().toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    tempMessageItem.innerHTML = `
                        <div class="message-header">
                            <span>æˆ‘</span>
                            <span>${time}</span>
                        </div>
                        <div class="message-content">${content}</div>
                    `;
                    messageList.appendChild(tempMessageItem);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    messageList.scrollTop = messageList.scrollHeight;
                    
                    // çŸ­æš‚å»¶è¿Ÿåé‡æ–°åŠ è½½æ¶ˆæ¯ï¼ˆæ¨¡æ‹ŸæœåŠ¡å™¨å“åº”ï¼‰
                    setTimeout(async () => {
                        await loadUserMessages();
                    }, 300);
                    
                    // æ˜¾ç¤ºå‘é€æˆåŠŸæç¤ºï¼ˆå¸¦å£°éŸ³ï¼‰
                    showReviewMessageWithSound('å‘é€æˆåŠŸ', 'æ¶ˆæ¯å·²å‘é€ç»™å®¢æœï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤æ‚¨ï¼');
                } else {
                    throw new Error('ä¿å­˜æ¶ˆæ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†
                sendMessageBtn.innerHTML = originalBtnContent;
                sendMessageBtn.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }
        
        // ç”Ÿæˆè®¢å•æ•°æ®ï¼ˆåŒ…å«ä»·æ ¼ä¿¡æ¯ï¼‰- æ–°å¢2ä¸ªè®¢å•ï¼Œå¹¶æŒ‰ç…§æœ€ä½ä»·æ ¼æ’åº
        function getOrderData() {
            const orderData = [
                // æ¯æ—¥ç­¾åˆ°è®¢å• - æ”¾åœ¨æœ€å‰é¢
                { 
                    title: "æ¯æ—¥ç­¾åˆ°", 
                    desc: "æ¯æ—¥ç­¾åˆ°å¯è·å¾—100ä¸ªä¼ ä¸–ç¢ç‰‡ï¼Œ1ä¸‡ä¸ªç¢ç‰‡å¯å…‘æ¢éšæœºä¸€æŠŠä¼ ä¸–æ­¦å™¨", 
                    category: "other", 
                    specs: [
                        { name: "ç­¾åˆ°", price: 0, originalPrice: 0, isDailySign: true }
                    ],
                    isDailySign: true  // æ ‡è®°ä¸ºæ¯æ—¥ç­¾åˆ°è®¢å•
                },
                { 
                    title: "ä¼ ä¸–æ­¦å™¨è½¬ç›˜", 
                    desc: "ç‚¹å‡»ä¸‹å•å‚ä¸æŠ½å¥–ï¼Œéšæœºè·å¾—ä¸€ä»¶ä¼ ä¸–æ­¦å™¨ï¼", 
                    category: "equipment", 
                    specs: [
                        { name: "ç‚¹å‡»æŠ½å¥–(1å…ƒæŠ½ä¼ ä¸–æ­¦å™¨)", price: 1, originalPrice: 299, isLottery: true, lotteryType: 'weapon' }
                    ] 
                },
                { 
                    title: "ç²‰ä¸ç¦åˆ©æŠ½å¥–ã€ä¼ ä¸–ã€‘", 
                    desc: "ç‚¹å‡»ä¸‹å•å‚ä¸æŠ½å¥–ï¼Œéšæœºè·å¾—ä¸€ä»¶ä¼ ä¸–è£…å¤‡ï¼", 
                    category: "equipment", 
                    specs: [
                        { name: "ç‚¹å‡»æŠ½å¥–(0.01å…ƒæŠ½ä¼ ä¸–è£…å¤‡)", price: 0.01, originalPrice: 9299, isLottery: true, lotteryType: 'equipment' }
                    ] 
                },
                { 
                    title: "åˆ®åœ°çš®å•", 
                    desc: "å†°æ²³ç¦åŒºåŸºç¡€åˆ®åœ°çš®ï¼Œ1å…ƒä¿100ä¸‡", 
                    category: "skin", 
                    specs: [
                        { name: "ä¸€ä¿ä¸€ã€ä¿100ä¸‡+6åŒ…ã€‘", price: 1, originalPrice: 3 },
                        { name: "äºŒä¿ä¸€ã€ä¿200ä¸‡+è½¬ç›˜ã€‘", price: 5.9, originalPrice: 10 },
                        { name: "ä¸‰ä¿ä¸€ã€ä¿300ä¸‡+è½¬ç›˜*2ã€‘", price: 7.9, originalPrice: 15 }
                    ] 
                },
                { 
                    title: "VIPä¼šå‘˜å¥—é¤", 
                    desc: "VIPç‰¹æƒï¼Œäº«å—å°Šè´µä½“éªŒï¼Œå…è´¹æŠ¤èˆª2æ¬¡", 
                    category: "vip", 
                    specs: [
                        { name: "æœˆå¡", price: 15, originalPrice: 55 },
                        { name: "å­£å¡", price: 40, originalPrice: 90 },
                        { name: "å¹´å¡", price: 120, originalPrice: 180 }
                    ] 
                },
                { 
                    title: "èµŒé‡‘å•", 
                    desc: "å‡º8æ ¹é‡‘æ¡ï¼Œé€1æŠŠä¼ ä¸–æ­¦å™¨", 
                    category: "other", 
                    specs: [
                        { name: "ä¸€ä¿ä¸€ã€ä¿100ä¸‡+7å¥—ã€‘", price: 7.9, originalPrice: 50 },
                        { name: "äºŒä¿ä¸€ã€ä¿200ä¸‡+7å¥—+éšæœºé‡‘ã€‘", price: 18.9, originalPrice: 90 },
                        { name: "ä¸‰ä¿ä¸€ã€ä¿400ä¸‡+7å¥—+éšæœºé‡‘*2+æŠ½å¥–ã€‘", price: 19.9, originalPrice: 160 }
                    ] 
                },
                { 
                    title: "çº¯å®åŠ›æŠ¤", 
                    desc: "çº¯æœ‰å®åŠ›çš„æŠ¤èˆª", 
                    category: "equipment", 
                    specs: [
                        { name: "ä¸€ä¿ä¸€ã€ä¿100ä¸‡+7å¥—+éšæœºé‡‘ã€‘", price: 10, originalPrice: 15 },
                        { name: "äºŒä¿ä¸€ã€ä¿300ä¸‡+7å¥—+éšæœºé‡‘+æŠ½å¥–*2ã€‘", price: 19.9, originalPrice: 25 },
                        { name: "ä¸‰ä¿ä¸€ã€ä¿400ä¸‡+7å¥—+éšæœºé‡‘+æŠ½å¥–*3ã€‘", price: 26.9, originalPrice: 30 }
                    ] 
                },
                { 
                    title: "è€é¼ å•", 
                    desc: "ä½¿ç”¨è€é¼ æ‰“æ³•æŠ¤èˆª", 
                    category: "other", 
                    specs: [
                        { name: "ä¸€ä¿ä¸€ã€ä¿100ä¸‡+6å¥—ã€‘", price: 3, originalPrice: 5 },
                        { name: "äºŒä¿ä¸€ã€ä¿150ä¸‡+éšæœºé‡‘+æŠ½å¥–ã€‘", price: 7.9, originalPrice: 10 },
                        { name: "ä¸‰ä¿ä¸€ã€éšæœºé‡‘*2+è½¬ç›˜*3ã€‘", price: 13.9, originalPrice: 20 }
                    ] 
                },
                { 
                    title: "ä¸»æ’­æŠ¤", 
                    desc: "æ¸¸é¾™äº²è‡ªæŠ¤èˆª", 
                    category: "equipment", 
                    specs: [
                        { name: "ä¿200ä¸‡ã€é€7å¥—+éšæœºé‡‘+ç¥ç¦è¯­ã€‘", price: 16.9, originalPrice: 25 }
                    ] 
                },
                { 
                    title: "æ·˜æ±°äººæœºå•", 
                    desc: "1å›¾æ¯æ·˜æ±°ä¸€ä¸ªäººæœºæŠ¤èˆª+10ä¸‡ï¼Œæ·˜æ±°çœŸäºº+30ä¸‡", 
                    category: "other", 
                    specs: [
                        { name: "ä¿åº•100ä¸‡", price: 19.9, originalPrice: 25 },
                        { name: "ä¿åº•200ä¸‡", price: 23.9, originalPrice: 45 },
                        { name: "ä¿åº•300ä¸‡", price: 29.9, originalPrice: 99 }
                    ] 
                },
                { 
                    title: "èµŒ2é‡‘å•", 
                    desc: "ä¸€å±€æ²¡æœ‰å‡ºã€2æ ¹é‡‘æ¡ã€‘ä¸€ç›´æŠ¤", 
                    category: "skin", 
                    specs: [
                        { name: "ä¸€ä¿ä¸€ã€é€7å¥—+é‡‘+æŠ½å¥–ã€‘", price: 29.9, originalPrice: 40 },
                        { name: "äºŒä¿ä¸€ã€é€7å¥—+é‡‘+æŠ½å¥–*2ã€‘", price: 49.9, originalPrice: 60 },
                        { name: "ä¸‰ä¿ä¸€ã€é€7å¥—+é‡‘*2+æŠ½å¥–*5ã€‘", price: 59.9, originalPrice: 110 }
                    ] 
                },
                { 
                    title: "èµŒæ©™å•", 
                    desc: "ä¸€å±€æ²¡å‡ºæ©™è‰²å˜å–ç‰©ä¸€ç›´æŠ¤", 
                    category: "equipment", 
                    specs: [
                        { name: "ä¸€ä¿ä¸€ã€é€7å¥—+éšæœºé‡‘ã€‘", price: 29.9, originalPrice: 40 },
                        { name: "äºŒä¿ä¸€ã€é€7å¥—+éšæœºé‡‘+æŠ½å¥–*2ã€‘", price: 49.9, originalPrice: 50 },
                        { name: "ä¸‰ä¿ä¸€ã€é€7å¥—+éšæœºé‡‘*2+æŠ½å¥–*5ã€‘", price: 59.9, originalPrice: 75 }
                    ] 
                },
                // æ–°å¢è®¢å•1
                { 
                    title: "AIç®—å‘½", 
                    desc: "AIç®—å‘½ï¼Œç»“æœä»…ä¾›å‚è€ƒ", 
                    category: "equipment", 
                    specs: [
                        { name: "ç®—å‘½ã€åŸºç¡€ã€‘ä¸‹å•åè¯·è”ç³»å®¢æœ", price: 1, originalPrice: 2 },
                        { name: "ç®—å‘½ã€è¯¦ç»†ã€‘ä¸‹å•åè¯·è”ç³»å®¢æœ", price: 2.5, originalPrice: 19 },
                        { name: "ç®—å‘½ã€ç§äººé¡¾é—®ã€‘", price: 6, originalPrice: 29 }
                    ] 
                },
                // æ–°å¢è®¢å•2 - ä¿®æ”¹ï¼šæ”¹ä¸ºå·²å”®å°½
                { 
                    title: "0.5å…ƒä¿åº•1000ä¸‡ã€å·²å”®å°½ã€‘", 
                    desc: "æ­¤å•†å“å·²å”®å°½ï¼Œè¯·å…³æ³¨å…¶ä»–å•†å“", 
                    category: "other", 
                    specs: [
                        { name: "ä¿åº•1000ä¸‡", price: 0.5, originalPrice: 30 },
                        { name: "ä¿åº•2000ä¸‡", price: 1.89, originalPrice: 150 },
                        { name: "ä¿åº•3000ä¸‡", price: 2.5, originalPrice: 300 }
                    ],
                    soldOut: true  // æ·»åŠ å·²å”®å°½æ ‡è®°
                },
                // æ–°å¢ï¼šå·²å”®å°½è®¢å•
                { 
                    title: "è´è¶åˆ€ï¼ˆæ¯æ—¥1æŠŠï¼Œ15ï¼š00å¼€å§‹ï¼‰ã€å·²å”®å°½ã€‘", 
                    desc: "æ­¤å•†å“å·²å”®å°½ï¼Œè¯·å…³æ³¨å…¶ä»–å•†å“", 
                    category: "other", 
                    specs: [
                        { name: "ç‰¹æƒ ä»·", price: 0.1, originalPrice: 9.9 }
                    ],
                    soldOut: true  // æ·»åŠ å·²å”®å°½æ ‡è®°
                }
            ];
            
            // æŒ‰ç…§æœ€ä½ä»·æ ¼æ’åºï¼ˆä»ä¾¿å®œåˆ°è´µï¼‰
            return orderData.sort((a, b) => {
                const minPriceA = Math.min(...a.specs.map(spec => spec.price));
                const minPriceB = Math.min(...b.specs.map(spec => spec.price));
                return minPriceA - minPriceB;
            });
        }
        
        // è®¡ç®—ä»·æ ¼èŒƒå›´
        function getPriceRange(specs) {
            if (!specs || specs.length === 0) return "ä»·æ ¼å¾…å®š";
            
            const prices = specs.map(spec => spec.price);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            
            if (minPrice === maxPrice) {
                return `Â¥${minPrice}`;
            } else {
                return `Â¥${minPrice} - Â¥${maxPrice}`;
            }
        }
        
        // è®¡ç®—åŸä»·èŒƒå›´
        function getOriginalPriceRange(specs) {
            if (!specs || specs.length === 0) return "";
            
            const originalPrices = specs.map(spec => spec.originalPrice);
            const minOriginalPrice = Math.min(...originalPrices);
            const maxOriginalPrice = Math.max(...originalPrices);
            
            if (minOriginalPrice === maxOriginalPrice) {
                return `åŸä»·: Â¥${minOriginalPrice}`;
            } else {
                return `åŸä»·: Â¥${minOriginalPrice} - Â¥${maxOriginalPrice}`;
            }
        }
        
        // ç”Ÿæˆè®¢å•æ•°æ®
        async function generateOrders() {
            const orderData = getOrderData();
            
            ordersGrid.innerHTML = '';
            
            for (const order of orderData) {
                const priceRange = getPriceRange(order.specs);
                const originalPriceRange = getOriginalPriceRange(order.specs);
                
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                // å¦‚æœæ˜¯å·²å”®å°½è®¢å•ï¼Œæ·»åŠ ç‰¹æ®Šç±»å
                if (order.soldOut) {
                    orderCard.classList.add('sold-out');
                }
                
                // å¦‚æœæ˜¯æ¯æ—¥ç­¾åˆ°è®¢å•ï¼Œæ·»åŠ ç‰¹æ®Šç±»å
                if (order.isDailySign) {
                    orderCard.classList.add('daily-sign');
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç­¾åˆ°
                let buttonText = "ç«‹å³ä¸‹å•";
                let buttonDisabled = false;
                
                if (order.isDailySign) {
                    buttonText = "ç‚¹å‡»ç­¾åˆ°";
                    
                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»ç­¾åˆ°
                    if (currentUser) {
                        const alreadySigned = await checkUserDailySign();
                        if (alreadySigned) {
                            buttonText = "ä»Šæ—¥å·²ç­¾åˆ°";
                            buttonDisabled = true;
                        }
                    }
                }
                
                orderCard.innerHTML = `
                    <div class="order-title">${order.title}</div>
                    <div class="order-price-range">${priceRange}</div>
                    <div class="order-original-price">${originalPriceRange}</div>
                    <div class="order-desc">${order.desc}</div>
                    <button class="order-btn" data-order="${orderData.indexOf(order)}" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button>
                `;
                ordersGrid.appendChild(orderCard);
            }
            
            document.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const orderIndex = parseInt(this.dataset.order);
                    const orderData = getOrderData();
                    const order = orderData[orderIndex];
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå·²å”®å°½è®¢å•
                    if (order.soldOut) {
                        alert("è¯¥å•†å“å·²å”®å°½ï¼Œè¯·é€‰æ‹©å…¶ä»–å•†å“");
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ¯æ—¥ç­¾åˆ°è®¢å•
                    if (order.isDailySign) {
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç­¾åˆ°
                        if (currentUser) {
                            const alreadySigned = await checkUserDailySign();
                            if (alreadySigned) {
                                alert("æ‚¨ä»Šå¤©å·²ç»ç­¾è¿‡åˆ°äº†ï¼Œè¯·æ˜å¤©å†æ¥ï¼");
                                return;
                            }
                        }
                        
                        // æ‰§è¡Œç­¾åˆ°
                        await userDailySign();
                        return;
                    }
                    
                    // æ£€æŸ¥æŠ½å¥–è®¢å•ç±»å‹
                    if (order.specs[0] && order.specs[0].isLottery) {
                        const lotteryType = order.specs[0].lotteryType;
                        
                        if (lotteryType === 'weapon') {
                            showLotteryModal(orderIndex);
                        } else if (lotteryType === 'equipment') {
                            showEquipmentLotteryModal(orderIndex);
                        } else {
                            // é»˜è®¤æ­¦å™¨æŠ½å¥–
                            showLotteryModal(orderIndex);
                        }
                    } else {
                        showOrderModal(orderIndex);
                    }
                });
            });
        }
        
        // æ˜¾ç¤ºä¼ ä¸–æ­¦å™¨è½¬ç›˜æŠ½å¥–å¼¹çª—
        function showLotteryModal(orderIndex) {
            const orderData = getOrderData();
            const order = orderData[orderIndex];
            
            lotteryOrder = order;
            selectedPrize = null;
            
            // é‡ç½®æŠ½å¥–ç•Œé¢
            startLotteryBtn.disabled = false;
            startLotteryBtn.innerHTML = 'å¼€å§‹æŠ½å¥–';
            startLotteryBtn.onclick = startLottery;
            lotteryResult.style.display = 'none';
            // ä¿®æ”¹ï¼šç¡®ä¿å–æ¶ˆæŒ‰é’®æ˜¾ç¤º
            cancelLotteryBtn.style.display = 'block';
            document.querySelectorAll('.prize-item').forEach(item => {
                item.classList.remove('selected', 'winning');
            });
            
            lotteryModal.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºä¼ ä¸–è£…å¤‡æŠ½å¥–å¼¹çª—
        async function showEquipmentLotteryModal(orderIndex) {
            const orderData = getOrderData();
            const order = orderData[orderIndex];
            
            equipmentOrder = order;
            selectedEquipmentPrize = null;
            
            // é‡ç½®æŠ½å¥–ç•Œé¢
            startEquipmentLotteryBtn.disabled = false;
            startEquipmentLotteryBtn.innerHTML = 'æŠ½ä¸€æ¬¡ (Â¥0.01)';
            startEquipmentLotteryBtn.onclick = startEquipmentLottery;
            
            // é‡ç½®æŠ½åæ¬¡æŒ‰é’®
            start10EquipmentLotteryBtn.disabled = false;
            start10EquipmentLotteryBtn.innerHTML = 'æŠ½åæ¬¡ (Â¥0.10)';
            start10EquipmentLotteryBtn.onclick = start10EquipmentLottery;
            
            equipmentLotteryResult.style.display = 'none';
            cancelEquipmentLotteryBtn.style.display = 'block';
            document.querySelectorAll('#equipmentPrizesContainer .prize-item').forEach(item => {
                item.classList.remove('selected', 'winning');
            });
            
            // æ›´æ–°ç¢ç‰‡æ˜¾ç¤º
            await updateFragmentDisplay();
            
            equipmentLotteryModal.style.display = 'flex';
        }
        
        // ç”Ÿæˆåˆ†ç±»è®¢å•
        async function generateCategoryOrders() {
            const orderData = getOrderData();
            
            categoryOrdersGrid.innerHTML = '';
            await filterOrdersByCategory('all');
            
            categories.forEach(category => {
                category.addEventListener('click', async function() {
                    const categoryType = this.dataset.category;
                    categories.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    await filterOrdersByCategory(categoryType);
                });
            });
        }
        
        // æ ¹æ®åˆ†ç±»è¿‡æ»¤è®¢å•ï¼ˆå¹¶æ’åºï¼‰
        async function filterOrdersByCategory(category) {
            const orderData = getOrderData();
            categoryOrdersGrid.innerHTML = '';
            
            let filteredOrders = orderData;
            if (category !== 'all') {
                filteredOrders = orderData.filter(order => order.category === category);
            }
            
            // æŒ‰ç…§æœ€ä½ä»·æ ¼æ’åºï¼ˆä»ä¾¿å®œåˆ°è´µï¼‰
            filteredOrders.sort((a, b) => {
                const minPriceA = Math.min(...a.specs.map(spec => spec.price));
                const minPriceB = Math.min(...b.specs.map(spec => spec.price));
                return minPriceA - minPriceB;
            });
            
            for (const order of filteredOrders) {
                const priceRange = getPriceRange(order.specs);
                const originalPriceRange = getOriginalPriceRange(order.specs);
                
                // æ‰¾åˆ°åŸè®¢å•åœ¨å…¨éƒ¨è®¢å•ä¸­çš„ç´¢å¼•
                const originalIndex = orderData.findIndex(o => o.title === order.title && o.desc === order.desc);
                
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                // å¦‚æœæ˜¯å·²å”®å°½è®¢å•ï¼Œæ·»åŠ ç‰¹æ®Šç±»å
                if (order.soldOut) {
                    orderCard.classList.add('sold-out');
                }
                
                // å¦‚æœæ˜¯æ¯æ—¥ç­¾åˆ°è®¢å•ï¼Œæ·»åŠ ç‰¹æ®Šç±»å
                if (order.isDailySign) {
                    orderCard.classList.add('daily-sign');
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç­¾åˆ°
                let buttonText = "ç«‹å³ä¸‹å•";
                let buttonDisabled = false;
                
                if (order.isDailySign) {
                    buttonText = "ç‚¹å‡»ç­¾åˆ°";
                    
                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»ç­¾åˆ°
                    if (currentUser) {
                        const alreadySigned = await checkUserDailySign();
                        if (alreadySigned) {
                            buttonText = "ä»Šæ—¥å·²ç­¾åˆ°";
                            buttonDisabled = true;
                        }
                    }
                }
                
                orderCard.innerHTML = `
                    <div class="order-title">${order.title}</div>
                    <div class="order-price-range">${priceRange}</div>
                    <div class="order-original-price">${originalPriceRange}</div>
                    <div class="order-desc">${order.desc}</div>
                    <button class="order-btn" data-order="${originalIndex !== -1 ? originalIndex : orderData.indexOf(order)}" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button>
                `;
                categoryOrdersGrid.appendChild(orderCard);
            }
            
            document.querySelectorAll('#categoryOrdersGrid .order-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const orderIndex = parseInt(this.dataset.order);
                    const orderData = getOrderData();
                    const order = orderData[orderIndex];
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå·²å”®å°½è®¢å•
                    if (order.soldOut) {
                        alert("è¯¥å•†å“å·²å”®å°½ï¼Œè¯·é€‰æ‹©å…¶ä»–å•†å“");
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ¯æ—¥ç­¾åˆ°è®¢å•
                    if (order.isDailySign) {
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç­¾åˆ°
                        if (currentUser) {
                            const alreadySigned = await checkUserDailySign();
                            if (alreadySigned) {
                                alert("æ‚¨ä»Šå¤©å·²ç»ç­¾è¿‡åˆ°äº†ï¼Œè¯·æ˜å¤©å†æ¥ï¼");
                                return;
                            }
                        }
                        
                        // æ‰§è¡Œç­¾åˆ°
                        await userDailySign();
                        return;
                    }
                    
                    // æ£€æŸ¥æŠ½å¥–è®¢å•ç±»å‹
                    if (order.specs[0] && order.specs[0].isLottery) {
                        const lotteryType = order.specs[0].lotteryType;
                        
                        if (lotteryType === 'weapon') {
                            showLotteryModal(orderIndex);
                        } else if (lotteryType === 'equipment') {
                            showEquipmentLotteryModal(orderIndex);
                        } else {
                            // é»˜è®¤æ­¦å™¨æŠ½å¥–
                            showLotteryModal(orderIndex);
                        }
                    } else {
                        showOrderModal(orderIndex);
                    }
                });
            });
        }
        
        // æ˜¾ç¤ºä¸‹å•å¼¹çª—ï¼ˆè§„æ ¼æŒ‰ä»·æ ¼æ’åºï¼‰
        function showOrderModal(orderIndex) {
            const orderData = getOrderData();
            const order = orderData[orderIndex];
            
            currentOrder = order;
            orderModalTitle.textContent = order.title;
            
            specsModal.innerHTML = '';
            
            // å¯¹è§„æ ¼æŒ‰ç…§ä»·æ ¼ä»ä½åˆ°é«˜æ’åº
            const sortedSpecs = [...order.specs].sort((a, b) => a.price - b.price);
            
            sortedSpecs.forEach((spec, index) => {
                // æ‰¾åˆ°åŸè§„æ ¼åœ¨order.specsä¸­çš„ç´¢å¼•
                const originalIndex = order.specs.findIndex(s => s.name === spec.name && s.price === spec.price);
                
                const specElement = document.createElement('div');
                specElement.className = 'spec-modal';
                specElement.dataset.spec = originalIndex;
                specElement.dataset.price = spec.price;
                specElement.innerHTML = `
                    <div class="spec-name">${spec.name}</div>
                    <div class="spec-price">Â¥${spec.price}</div>
                `;
                specsModal.appendChild(specElement);
            });
            
            document.querySelectorAll('.spec-modal').forEach(spec => {
                spec.addEventListener('click', function() {
                    document.querySelectorAll('.spec-modal').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    selectedSpec = parseInt(this.dataset.spec);
                });
            });
            
            orderModal.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºä¸»åº”ç”¨
        async function showMainApp() {
            console.log('æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢');
            gameNameModal.style.display = 'none';
            serverModal.style.display = 'none';
            wechatModal.style.display = 'none';
            mainContainer.style.display = 'block';
            
            userNameElement.textContent = currentUser.name;
            userServerElement.textContent = `åŒºæœ: ${currentUser.server}`;
            userWechatElement.textContent = `å¾®ä¿¡å·/æ‰‹æœºå·: ${currentUser.wechat}`;
            
            // é‡æ–°ç”Ÿæˆè®¢å•ä»¥æ›´æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€
            await generateOrders();
            await generateCategoryOrders();
            
            setTimeout(() => {
                showReviewMessageWithSound('æ¬¢è¿', `ã€æ–°å•ã€‘æ¨å‡º0.5å…ƒä¿åº•1000ä¸‡ï¼Œ${currentUser.name}ï¼`);
            }, 1000);
        }
        
        // æ˜¾ç¤ºå®¡æ ¸æ¶ˆæ¯ï¼ˆå¸¦å£°éŸ³ï¼‰
        function showReviewMessageWithSound(title, message) {
            // æ’­æ”¾é€šçŸ¥å£°éŸ³
            playNotificationSound();
            
            reviewTitle.textContent = title;
            reviewMessage.textContent = message;
            reviewModal.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºå®¡æ ¸æ¶ˆæ¯ï¼ˆä¸å¸¦å£°éŸ³ï¼‰
        function showReviewMessage(title, message) {
            reviewTitle.textContent = title;
            reviewMessage.textContent = message;
            reviewModal.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
        function showPaymentModal(order, spec) {
            const specData = order.specs[spec];
            const amount = specData.price;
            
            paymentAmount.textContent = `Â¥${amount}`;
            document.getElementById('paymentAmountText').textContent = `Â¥${amount}`;
            paymentModal.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºè®¢å•åŠ è½½åŠ¨ç”»
        function showOrderLoading() {
            orderLoading.style.display = 'flex';
        }
        
        // éšè—è®¢å•åŠ è½½åŠ¨ç”»
        function hideOrderLoading() {
            orderLoading.style.display = 'none';
        }
        
        // æ›´æ–°ç”¨æˆ·è®¢å•
        async function updateUserOrders() {
            try {
                userOrdersList.innerHTML = '<div class="status-card"><div class="status-desc">æ­£åœ¨åŠ è½½è®¢å•...</div></div>';
                
                const allOrders = await storageManager.get('orders') || [];
                const userOrders = allOrders.filter(order => order.userId === currentUser.id);
                
                userOrdersList.innerHTML = '';
                
                if (userOrders.length === 0) {
                    userOrdersList.innerHTML = '<div class="status-card"><div class="status-desc">æš‚æ— è®¢å•</div></div>';
                    return;
                }
                
                userOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                userOrders.forEach(order => {
                    const statusCard = document.createElement('div');
                    statusCard.className = 'status-card';
                    
                    let statusText = '';
                    if (order.status === 'pending') {
                        statusText = 'çŠ¶æ€: æ­£åœ¨å®¡æ ¸ä¸­';
                    } else if (order.status === 'approved') {
                        statusText = 'çŠ¶æ€: å®¡æ ¸é€šè¿‡';
                    } else {
                        statusText = `çŠ¶æ€: å®¡æ ¸æœªé€šè¿‡ - ç†ç”±: ${order.reason || 'ä¿¡æ¯ä¸å®Œæ•´'}`;
                    }
                    
                    const formattedTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                    
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰é€€æ¬¾ç”³è¯·
                    const hasRefund = order.refundRequested || false;
                    
                    statusCard.innerHTML = `
                        <div class="status-title">${order.orderTitle} - ${order.spec}</div>
                        <div class="status-desc">è®¢å•é‡‘é¢: Â¥${order.price}</div>
                        <div class="status-desc">${statusText}</div>
                        <div class="status-desc">ä¸‹å•æ—¶é—´: ${formattedTime}</div>
                        ${order.isLottery ? '<div class="status-desc" style="color:#FFD700;">âœ¨ æŠ½å¥–è®¢å•</div>' : ''}
                        ${hasRefund ? '<div class="status-desc" style="color:#ff6b6b;">âš ï¸ å·²ç”³è¯·é€€æ¬¾</div>' : ''}
                        ${order.refundStatus ? `<div class="status-desc" style="color:#ff6b6b;">é€€æ¬¾çŠ¶æ€: ${order.refundStatus === 'approved' ? 'å·²é€€æ¬¾' : 'é€€æ¬¾è¢«æ‹’ç»'}</div>` : ''}
                    `;
                    
                    // æ·»åŠ é€€æ¬¾æŒ‰é’®ï¼ˆåªæœ‰å®¡æ ¸é€šè¿‡çš„è®¢å•æ‰èƒ½ç”³è¯·é€€æ¬¾ï¼Œå¹¶ä¸”æ²¡æœ‰é€€æ¬¾ç”³è¯·æˆ–é€€æ¬¾ç”³è¯·è¢«æ‹’ç»ï¼‰
                    if (order.status === 'approved' && !hasRefund) {
                        const refundBtn = document.createElement('button');
                        refundBtn.className = 'refund-btn';
                        refundBtn.textContent = 'ç”³è¯·é€€æ¬¾';
                        refundBtn.dataset.orderId = order.id;
                        refundBtn.addEventListener('click', () => applyForRefund(order.id));
                        statusCard.appendChild(refundBtn);
                    } else if (hasRefund && order.refundStatus === 'pending') {
                        const refundBtn = document.createElement('button');
                        refundBtn.className = 'refund-btn';
                        refundBtn.textContent = 'é€€æ¬¾å®¡æ ¸ä¸­';
                        refundBtn.disabled = true;
                        refundBtn.style.background = '#6c757d';
                        statusCard.appendChild(refundBtn);
                    }
                    
                    userOrdersList.appendChild(statusCard);
                });
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·è®¢å•å¤±è´¥:', error);
                userOrdersList.innerHTML = `
                    <div class="status-card">
                        <div class="status-desc">åŠ è½½è®¢å•å¤±è´¥: ${error.message}</div>
                        <button class="modal-btn" style="width: auto; margin-top: 10px;" onclick="loadMockOrders()">æŸ¥çœ‹æ¼”ç¤ºæ•°æ®</button>
                    </div>
                `;
            }
        }
        
        // ç”³è¯·é€€æ¬¾
        async function applyForRefund(orderId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            try {
                const allOrders = await storageManager.get('orders') || [];
                const order = allOrders.find(o => o.id === orderId && o.userId === currentUser.id);
                
                if (!order) {
                    alert('è®¢å•ä¸å­˜åœ¨æˆ–ä¸å±äºæ‚¨');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰é€€æ¬¾ç”³è¯·
                if (order.refundRequested) {
                    alert('æ‚¨å·²ç»ç”³è¯·è¿‡é€€æ¬¾äº†');
                    return;
                }
                
                // æ˜¾ç¤ºé€€æ¬¾ç”³è¯·å¼¹çª—
                refundModal.style.display = 'flex';
                refundReason.value = '';
                
                // æ˜¾ç¤ºè®¢å•ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…ä¸Šå¯ä»¥æ˜¾ç¤ºæ›´å¤šä¿¡æ¯ï¼‰
                refundOrderList.innerHTML = `
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div><strong>è®¢å•:</strong> ${order.orderTitle} - ${order.spec}</div>
                        <div><strong>é‡‘é¢:</strong> Â¥${order.price}</div>
                        <div><strong>ä¸‹å•æ—¶é—´:</strong> ${new Date(order.timestamp).toLocaleString()}</div>
                    </div>
                `;
                
                // è®¾ç½®æäº¤æŒ‰é’®äº‹ä»¶
                submitRefundBtn.onclick = async () => {
                    try {
                        // æ›´æ–°è®¢å•çŠ¶æ€ï¼Œæ ‡è®°ä¸ºå·²ç”³è¯·é€€æ¬¾
                        const orderIndex = allOrders.findIndex(o => o.id === orderId);
                        if (orderIndex !== -1) {
                            allOrders[orderIndex].refundRequested = true;
                            allOrders[orderIndex].refundStatus = 'pending';
                            allOrders[orderIndex].refundReason = refundReason.value || 'æ— åŸå› ';
                            allOrders[orderIndex].refundRequestTime = new Date().toISOString();
                            
                            await storageManager.save('orders', allOrders);
                            
                            // å…³é—­å¼¹çª—
                            refundModal.style.display = 'none';
                            
                            // æ›´æ–°ç”¨æˆ·è®¢å•åˆ—è¡¨
                            updateUserOrders();
                            
                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            showReviewMessageWithSound('é€€æ¬¾ç”³è¯·å·²æäº¤', 'æ‚¨çš„é€€æ¬¾ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ï¼');
                        }
                    } catch (error) {
                        console.error('æäº¤é€€æ¬¾ç”³è¯·å¤±è´¥:', error);
                        alert('æäº¤é€€æ¬¾ç”³è¯·å¤±è´¥: ' + error.message);
                    }
                };
                
            } catch (error) {
                console.error('ç”³è¯·é€€æ¬¾å¤±è´¥:', error);
                alert('ç”³è¯·é€€æ¬¾å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½æ¨¡æ‹Ÿè®¢å•æ•°æ®
        function loadMockOrders() {
            const mockOrders = [
                {
                    id: 'mock-1',
                    orderTitle: 'é«˜çº§è£…å¤‡ç¤¼åŒ…',
                    spec: 'æ ‡å‡†ç‰ˆ(3ä»¶)',
                    price: 25,
                    status: 'approved',
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000)
                },
                {
                    id: 'mock-2',
                    orderTitle: 'ç¨€æœ‰çš®è‚¤æŠ½å¥–',
                    spec: 'ç¨€æœ‰çš®è‚¤',
                    price: 20,
                    status: 'pending',
                    timestamp: new Date(Date.now() - 30 * 60 * 1000)
                },
                {
                    id: 'mock-3',
                    orderTitle: 'VIPä¼šå‘˜å¥—é¤',
                    spec: 'æœˆå¡',
                    price: 15,
                    status: 'rejected',
                    reason: 'ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·æä¾›æ›´å¤šè¯¦æƒ…',
                    timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000)
                }
            ];
            
            userOrdersList.innerHTML = '';
            
            mockOrders.forEach(order => {
                const statusCard = document.createElement('div');
                statusCard.className = 'status-card';
                
                let statusText = '';
                if (order.status === 'pending') {
                    statusText = 'çŠ¶æ€: æ­£åœ¨å®¡æ ¸ä¸­ï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰';
                } else if (order.status === 'approved') {
                    statusText = 'çŠ¶æ€: å®¡æ ¸é€šè¿‡ï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰';
                } else {
                    statusText = `çŠ¶æ€: å®¡æ ¸æœªé€šè¿‡ï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰ - ç†ç”±: ${order.reason || 'ä¿¡æ¯ä¸å®Œæ•´'}`;
                }
                
                statusCard.innerHTML = `
                    <div class="status-title">${order.orderTitle} - ${order.spec}</div>
                    <div class="status-desc">è®¢å•é‡‘é¢: Â¥${order.price}</div>
                    <div class="status-desc">${statusText}</div>
                    <div class="status-desc">ä¸‹å•æ—¶é—´: ${order.timestamp.toLocaleString()}</div>
                `;
                userOrdersList.appendChild(statusCard);
            });
        }
        
        // è®¾ç½®è®¢å•é€šçŸ¥ç›‘å¬
        function setupOrderNotifications() {
            if (!currentUser) return;
            
            const checkOrderStatus = async () => {
                try {
                    const allOrders = await storageManager.get('orders') || [];
                    const userOrders = allOrders.filter(order => order.userId === currentUser.id);
                    
                    userOrders.forEach(order => {
                        const localOrders = JSON.parse(localStorage.getItem('localOrders') || '{}');
                        const oldStatus = localOrders[order.id];
                        
                        if (oldStatus && oldStatus !== order.status) {
                            if (order.status === 'approved') {
                                showReviewMessageWithSound('å®¡æ ¸é€šè¿‡', 'æ‚¨çš„è®¢å•å·²é€šè¿‡å®¡æ ¸ï¼');
                            } else if (order.status === 'rejected') {
                                showReviewMessageWithSound('å®¡æ ¸æœªé€šè¿‡', `æ‚¨çš„è®¢å•æœªé€šè¿‡å®¡æ ¸ï¼Œç†ç”±: ${order.reason || 'ä¿¡æ¯ä¸ç¬¦åˆè¦æ±‚'}`);
                            }
                        }
                        
                        localOrders[order.id] = order.status;
                        localStorage.setItem('localOrders', JSON.stringify(localOrders));
                    });
                } catch (error) {
                    console.error('æ£€æŸ¥è®¢å•çŠ¶æ€å¤±è´¥:', error);
                }
            };
            
            setInterval(checkOrderStatus, 30000);
            checkOrderStatus();
        }
        
        // æ›´æ–°åå°ç®¡ç†ç•Œé¢
        async function updateAdminPanel() {
            try {
                userList.innerHTML = '<div class="user-item">æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...</div>';
                adminOrderList.innerHTML = '<div class="order-item">æ­£åœ¨åŠ è½½è®¢å•æ•°æ®...</div>';
                processedOrderList.innerHTML = '<div class="order-item">æ­£åœ¨åŠ è½½å·²å¤„ç†è®¢å•æ•°æ®...</div>';
                adminMessageList.innerHTML = '<div class="message-item-admin">æ­£åœ¨åŠ è½½æ¶ˆæ¯æ•°æ®...</div>';
                pendingRefundList.innerHTML = '<div class="refund-item">æ­£åœ¨åŠ è½½é€€æ¬¾æ•°æ®...</div>';
                processedRefundList.innerHTML = '<div class="refund-item">æ­£åœ¨åŠ è½½å·²å¤„ç†é€€æ¬¾æ•°æ®...</div>';
                
                // åŠ è½½ç”¨æˆ·æ•°æ®
                const allUsers = await storageManager.get('users') || [];
                
                userList.innerHTML = '';
                
                if (allUsers.length === 0) {
                    userList.innerHTML = '<div class="user-item">æš‚æ— ç”¨æˆ·æ•°æ®</div>';
                } else {
                    allUsers.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        
                        const formattedTime = user.registerTime ? new Date(user.registerTime).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                        const lastSignDate = user.lastSignDate ? new Date(user.lastSignDate).toLocaleDateString() : 'ä»æœªç­¾åˆ°';
                        
                        userItem.innerHTML = `
                            <div><strong>${user.name}</strong> - ${user.server}</div>
                            <div>å¾®ä¿¡å·/æ‰‹æœºå·: ${user.wechat}</div>
                            <div>æ³¨å†Œæ—¶é—´: ${formattedTime}</div>
                            <div>ä¼ ä¸–ç¢ç‰‡: ${user.fragments || 0} ä¸ª</div>
                            <div>é¦–æ¬¡æŠ½å¥–: ${user.firstLotteryDone ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}</div>
                            <div>æœ€åç­¾åˆ°: ${lastSignDate}</div>
                        `;
                        userList.appendChild(userItem);
                    });
                }
                
                // æ›´æ–°ç»™ç”¨æˆ·å‘æ¶ˆæ¯çš„é€‰æ‹©æ¡†
                updateSendToUserSelect(allUsers);
                
                // åŠ è½½è®¢å•æ•°æ®
                adminOrderList.innerHTML = '';
                processedOrderList.innerHTML = '';
                const allOrders = await storageManager.get('orders') || [];
                
                if (allOrders.length === 0) {
                    adminOrderList.innerHTML = '<div class="order-item">æš‚æ— å¾…å®¡æ ¸è®¢å•</div>';
                    processedOrderList.innerHTML = '<div class="order-item">æš‚æ— å·²å¤„ç†è®¢å•</div>';
                } else {
                    allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    const pendingOrders = allOrders.filter(order => order.status === 'pending');
                    const processedOrders = allOrders.filter(order => order.status !== 'pending');
                    
                    // æ˜¾ç¤ºå¾…å®¡æ ¸è®¢å•
                    if (pendingOrders.length === 0) {
                        adminOrderList.innerHTML = '<div class="order-item">æš‚æ— å¾…å®¡æ ¸è®¢å•</div>';
                    } else {
                        pendingOrders.forEach(order => {
                            const orderItem = document.createElement('div');
                            orderItem.className = 'order-item';
                            
                            const formattedTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                            
                            orderItem.innerHTML = `
                                <div><strong>è®¢å• #${order.id}</strong></div>
                                <div>ç”¨æˆ·: ${order.userName} (${order.userServer})</div>
                                <div>å¾®ä¿¡å·: ${order.userWechat || 'æœªçŸ¥'}</div>
                                <div>å•†å“: ${order.orderTitle} - ${order.spec}</div>
                                <div>é‡‘é¢: Â¥${order.price}</div>
                                <div>æ—¶é—´: ${formattedTime}</div>
                                <div>çŠ¶æ€: å®¡æ ¸ä¸­</div>
                                ${order.isLottery ? '<div>ç±»å‹: æŠ½å¥–è®¢å•</div>' : ''}
                                ${order.fragmentsEarned ? `<div>è·å¾—ç¢ç‰‡: ${order.fragmentsEarned} ä¸ª</div>` : ''}
                                ${order.isFirstLottery ? '<div style="color:#FFD700;">âœ¨ é¦–æ¬¡æŠ½å¥–å¥–åŠ±</div>' : ''}
                                <div class="order-actions">
                                    <button class="approve-btn" data-order="${order.id}">é€šè¿‡</button>
                                    <button class="reject-btn" data-order="${order.id}">æ‹’ç»</button>
                                </div>
                            `;
                            adminOrderList.appendChild(orderItem);
                        });
                    }
                    
                    // æ˜¾ç¤ºå·²å¤„ç†è®¢å•
                    if (processedOrders.length === 0) {
                        processedOrderList.innerHTML = '<div class="order-item">æš‚æ— å·²å¤„ç†è®¢å•</div>';
                    } else {
                        processedOrders.forEach(order => {
                            const orderItem = document.createElement('div');
                            orderItem.className = 'order-item';
                            
                            const formattedTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                            const statusText = order.status === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»';
                            const statusClass = order.status === 'approved' ? 'approve-btn' : 'reject-btn';
                            
                            orderItem.innerHTML = `
                                <div><strong>è®¢å• #${order.id}</strong></div>
                                <div>ç”¨æˆ·: ${order.userName} (${order.userServer})</div>
                                <div>å¾®ä¿¡å·: ${order.userWechat || 'æœªçŸ¥'}</div>
                                <div>å•†å“: ${order.orderTitle} - ${order.spec}</div>
                                <div>é‡‘é¢: Â¥${order.price}</div>
                                <div>æ—¶é—´: ${formattedTime}</div>
                                <div>çŠ¶æ€: <button class="${statusClass}" style="cursor: default;">${statusText}</button></div>
                                ${order.reason ? `<div>æ‹’ç»ç†ç”±: ${order.reason}</div>` : ''}
                                ${order.isLottery ? '<div>ç±»å‹: æŠ½å¥–è®¢å•</div>' : ''}
                                ${order.fragmentsEarned ? `<div>è·å¾—ç¢ç‰‡: ${order.fragmentsEarned} ä¸ª</div>` : ''}
                                ${order.isFirstLottery ? '<div style="color:#FFD700;">âœ¨ é¦–æ¬¡æŠ½å¥–å¥–åŠ±</div>' : ''}
                            `;
                            processedOrderList.appendChild(orderItem);
                        });
                    }
                    
                    // æ·»åŠ è®¢å•æ“ä½œæŒ‰é’®äº‹ä»¶ç›‘å¬
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        if (!btn.hasAttribute('data-order')) return;
                        
                        btn.addEventListener('click', async function() {
                            const orderId = this.dataset.order;
                            try {
                                const allOrders = await storageManager.get('orders') || [];
                                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                                
                                if (orderIndex !== -1) {
                                    allOrders[orderIndex].status = 'approved';
                                    allOrders[orderIndex].updatedAt = new Date().toISOString();
                                    
                                    await storageManager.save('orders', allOrders);
                                    updateAdminPanel();
                                    
                                    const order = allOrders[orderIndex];
                                    // æ˜¾ç¤ºå®¡æ ¸é€šè¿‡çš„å¼¹çª—
                                    showReviewMessageWithSound('å®¡æ ¸é€šè¿‡', `è®¢å• #${order.id} å·²å®¡æ ¸é€šè¿‡ï¼`);
                                    
                                    if (currentUser && order.userId === currentUser.id) {
                                        updateUserOrders();
                                        showReviewMessageWithSound('å®¡æ ¸é€šè¿‡', 'æ‚¨çš„è®¢å•å·²é€šè¿‡å®¡æ ¸ï¼');
                                    }
                                    
                                    alert('å®¡æ ¸é€šè¿‡ï¼');
                                }
                            } catch (error) {
                                console.error('å®¡æ ¸è®¢å•å¤±è´¥:', error);
                                alert('å®¡æ ¸å¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        });
                    });
                    
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        if (!btn.hasAttribute('data-order')) return;
                        
                        btn.addEventListener('click', async function() {
                            const orderId = this.dataset.order;
                            const reason = prompt('è¯·è¾“å…¥æ‹’ç»ç†ç”±:', 'ä¿¡æ¯ä¸ç¬¦åˆè¦æ±‚');
                            
                            if (reason === null) return;
                            
                            try {
                                const allOrders = await storageManager.get('orders') || [];
                                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                                
                                if (orderIndex !== -1) {
                                    allOrders[orderIndex].status = 'rejected';
                                    allOrders[orderIndex].reason = reason;
                                    allOrders[orderIndex].updatedAt = new Date().toISOString();
                                    
                                    await storageManager.save('orders', allOrders);
                                    updateAdminPanel();
                                    
                                    const order = allOrders[orderIndex];
                                    // æ˜¾ç¤ºå®¡æ ¸æœªé€šè¿‡çš„å¼¹çª—
                                    showReviewMessageWithSound('å®¡æ ¸æœªé€šè¿‡', `è®¢å• #${order.id} å·²æ‹’ç»ï¼`);
                                    
                                    if (currentUser && order.userId === currentUser.id) {
                                        updateUserOrders();
                                        showReviewMessageWithSound('å®¡æ ¸æœªé€šè¿‡', `æ‚¨çš„è®¢å•æœªé€šè¿‡å®¡æ ¸ï¼Œç†ç”±: ${reason}`);
                                    }
                                    
                                    alert('å·²æ‹’ç»è®¢å•ï¼');
                                }
                            } catch (error) {
                                console.error('æ‹’ç»è®¢å•å¤±è´¥:', error);
                                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        });
                    });
                }
                
                // åŠ è½½å¹¶æ˜¾ç¤ºæ¶ˆæ¯
                adminMessageList.innerHTML = '';
                const allMessages = await storageManager.get('messages') || [];
                
                if (allMessages.length === 0) {
                    adminMessageList.innerHTML = '<div class="message-item-admin">æš‚æ— ç”¨æˆ·æ¶ˆæ¯</div>';
                } else {
                    // è·å–ç”¨æˆ·æ¶ˆæ¯ï¼ˆtypeä¸º'user'çš„æ¶ˆæ¯ï¼‰
                    const userMessages = allMessages.filter(msg => msg.type === 'user');
                    
                    // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
                    userMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    userMessages.forEach(message => {
                        const messageItem = document.createElement('div');
                        messageItem.className = 'message-item-admin';
                        
                        const formattedTime = new Date(message.timestamp).toLocaleString('zh-CN');
                        
                        // è·å–è¯¥æ¶ˆæ¯çš„æ‰€æœ‰å®¢æœå›å¤
                        const replies = allMessages.filter(msg => 
                            msg.type === 'admin' && msg.relatedMessageId === message.id
                        );
                        
                        // è·å–æ¶ˆæ¯çŠ¶æ€
                        let statusText = 'æœªè¯»';
                        if (replies.length > 0) {
                            statusText = 'å·²å›å¤';
                        } else if (message.status === 'read') {
                            statusText = 'å·²è¯»';
                        }
                        
                        messageItem.innerHTML = `
                            <div><strong>${message.userName} (${message.userServer})</strong></div>
                            <div>å¾®ä¿¡å·: ${message.userWechat || 'æœªçŸ¥'}</div>
                            <div>æ—¶é—´: ${formattedTime}</div>
                            <div>çŠ¶æ€: ${statusText}</div>
                            <div class="message-content-admin">
                                <strong>ç”¨æˆ·æ¶ˆæ¯:</strong><br>
                                ${message.content}
                            </div>
                            ${replies.length > 0 ? `
                                <div class="replies-container">
                                    <strong>å®¢æœå›å¤:</strong>
                                    ${replies.map(reply => `
                                        <div class="reply-item">
                                            ${reply.content}
                                            <div class="reply-time">
                                                ${new Date(reply.timestamp).toLocaleString('zh-CN')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="message-reply-area">
                                <textarea class="reply-input" rows="3" placeholder="è¾“å…¥å›å¤å†…å®¹..." data-message="${message.id}"></textarea>
                                <button class="reply-btn" data-message="${message.id}">å‘é€å›å¤</button>
                            </div>
                        `;
                        adminMessageList.appendChild(messageItem);
                    });
                    
                    // æ·»åŠ å›å¤æŒ‰é’®äº‹ä»¶ç›‘å¬
                    document.querySelectorAll('.reply-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const messageId = this.dataset.message;
                            const textarea = document.querySelector(`textarea[data-message="${messageId}"]`);
                            const replyContent = textarea.value.trim();
                            
                            if (!replyContent) {
                                alert('è¯·è¾“å…¥å›å¤å†…å®¹');
                                return;
                            }
                            
                            try {
                                const allMessages = await storageManager.get('messages') || [];
                                
                                // æ·»åŠ å®¢æœå›å¤æ¶ˆæ¯
                                const replyMessage = {
                                    id: 'msg-reply-' + Date.now(),
                                    userId: allMessages.find(msg => msg.id === messageId)?.userId || '',
                                    userName: allMessages.find(msg => msg.id === messageId)?.userName || '',
                                    userServer: allMessages.find(msg => msg.id === messageId)?.userServer || '',
                                    userWechat: allMessages.find(msg => msg.id === messageId)?.userWechat || '',
                                    type: 'admin',
                                    content: replyContent,
                                    timestamp: new Date().toISOString(),
                                    status: 'unread', // è®¾ç½®ä¸ºæœªè¯»ï¼Œç”¨æˆ·ç«¯ä¼šå¼¹çª—æç¤º
                                    relatedMessageId: messageId
                                };
                                
                                allMessages.push(replyMessage);
                                
                                // æ›´æ–°åŸæ¶ˆæ¯çŠ¶æ€
                                const messageIndex = allMessages.findIndex(msg => msg.id === messageId);
                                if (messageIndex !== -1) {
                                    allMessages[messageIndex].status = 'replied';
                                }
                                
                                await storageManager.save('messages', allMessages);
                                updateAdminPanel();
                                
                                alert('å›å¤æˆåŠŸï¼ç”¨æˆ·å°†æ”¶åˆ°å¼¹çª—é€šçŸ¥ã€‚');
                            } catch (error) {
                                console.error('å›å¤æ¶ˆæ¯å¤±è´¥:', error);
                                alert('å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        });
                    });
                }
                
                // åŠ è½½é€€æ¬¾ç”³è¯·æ•°æ®
                pendingRefundList.innerHTML = '';
                processedRefundList.innerHTML = '';
                
                if (allOrders.length === 0) {
                    pendingRefundList.innerHTML = '<div class="refund-item">æš‚æ— å¾…å®¡æ ¸é€€æ¬¾ç”³è¯·</div>';
                    processedRefundList.innerHTML = '<div class="refund-item">æš‚æ— å·²å¤„ç†é€€æ¬¾ç”³è¯·</div>';
                } else {
                    // è·å–æ‰€æœ‰å·²ç”³è¯·é€€æ¬¾çš„è®¢å•
                    const refundOrders = allOrders.filter(order => order.refundRequested);
                    
                    // å¾…å®¡æ ¸é€€æ¬¾ç”³è¯·
                    const pendingRefunds = refundOrders.filter(order => order.refundStatus === 'pending');
                    // å·²å¤„ç†é€€æ¬¾ç”³è¯·
                    const processedRefunds = refundOrders.filter(order => order.refundStatus !== 'pending' && order.refundStatus !== undefined);
                    
                    // æ˜¾ç¤ºå¾…å®¡æ ¸é€€æ¬¾ç”³è¯·
                    if (pendingRefunds.length === 0) {
                        pendingRefundList.innerHTML = '<div class="refund-item">æš‚æ— å¾…å®¡æ ¸é€€æ¬¾ç”³è¯·</div>';
                    } else {
                        pendingRefunds.forEach(order => {
                            const refundItem = document.createElement('div');
                            refundItem.className = 'refund-item';
                            
                            const formattedTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                            const refundRequestTime = order.refundRequestTime ? new Date(order.refundRequestTime).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                            
                            refundItem.innerHTML = `
                                <div><strong>é€€æ¬¾ç”³è¯· - è®¢å• #${order.id}</strong></div>
                                <div>ç”¨æˆ·: ${order.userName} (${order.userServer})</div>
                                <div>å¾®ä¿¡å·: ${order.userWechat || 'æœªçŸ¥'}</div>
                                <div>è®¢å•: ${order.orderTitle} - ${order.spec}</div>
                                <div>è®¢å•é‡‘é¢: Â¥${order.price}</div>
                                <div>ä¸‹å•æ—¶é—´: ${formattedTime}</div>
                                <div>ç”³è¯·é€€æ¬¾æ—¶é—´: ${refundRequestTime}</div>
                                <div>é€€æ¬¾åŸå› : ${order.refundReason || 'æ— åŸå› '}</div>
                                <div class="refund-actions">
                                    <button class="approve-btn" data-refund-order="${order.id}">é€šè¿‡é€€æ¬¾</button>
                                    <button class="reject-btn" data-refund-order="${order.id}">æ‹’ç»é€€æ¬¾</button>
                                </div>
                            `;
                            pendingRefundList.appendChild(refundItem);
                        });
                    }
                    
                    // æ˜¾ç¤ºå·²å¤„ç†é€€æ¬¾ç”³è¯·
                    if (processedRefunds.length === 0) {
                        processedRefundList.innerHTML = '<div class="refund-item">æš‚æ— å·²å¤„ç†é€€æ¬¾ç”³è¯·</div>';
                    } else {
                        processedRefunds.forEach(order => {
                            const refundItem = document.createElement('div');
                            refundItem.className = 'refund-item';
                            
                            const formattedTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                            const refundRequestTime = order.refundRequestTime ? new Date(order.refundRequestTime).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                            const refundStatusText = order.refundStatus === 'approved' ? 'å·²é€€æ¬¾' : 'é€€æ¬¾è¢«æ‹’ç»';
                            const refundStatusClass = order.refundStatus === 'approved' ? 'approve-btn' : 'reject-btn';
                            
                            refundItem.innerHTML = `
                                <div><strong>é€€æ¬¾ç”³è¯· - è®¢å• #${order.id}</strong></div>
                                <div>ç”¨æˆ·: ${order.userName} (${order.userServer})</div>
                                <div>å¾®ä¿¡å·: ${order.userWechat || 'æœªçŸ¥'}</div>
                                <div>è®¢å•: ${order.orderTitle} - ${order.spec}</div>
                                <div>è®¢å•é‡‘é¢: Â¥${order.price}</div>
                                <div>ä¸‹å•æ—¶é—´: ${formattedTime}</div>
                                <div>ç”³è¯·é€€æ¬¾æ—¶é—´: ${refundRequestTime}</div>
                                <div>é€€æ¬¾åŸå› : ${order.refundReason || 'æ— åŸå› '}</div>
                                <div>é€€æ¬¾çŠ¶æ€: <button class="${refundStatusClass}" style="cursor: default;">${refundStatusText}</button></div>
                                ${order.refundReviewReason ? `<div>å®¡æ ¸å¤‡æ³¨: ${order.refundReviewReason}</div>` : ''}
                            `;
                            processedRefundList.appendChild(refundItem);
                        });
                    }
                    
                    // æ·»åŠ é€€æ¬¾å®¡æ ¸æŒ‰é’®äº‹ä»¶ç›‘å¬
                    document.querySelectorAll('.approve-btn[data-refund-order]').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const orderId = this.dataset.refundOrder;
                            try {
                                const allOrders = await storageManager.get('orders') || [];
                                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                                
                                if (orderIndex !== -1) {
                                    const reason = prompt('è¯·è¾“å…¥å®¡æ ¸å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
                                    
                                    allOrders[orderIndex].refundStatus = 'approved';
                                    allOrders[orderIndex].refundReviewReason = reason || '';
                                    allOrders[orderIndex].refundReviewTime = new Date().toISOString();
                                    
                                    await storageManager.save('orders', allOrders);
                                    updateAdminPanel();
                                    
                                    const order = allOrders[orderIndex];
                                    // æ˜¾ç¤ºå®¡æ ¸é€šè¿‡çš„å¼¹çª—
                                    showReviewMessageWithSound('é€€æ¬¾å®¡æ ¸é€šè¿‡', `è®¢å• #${order.id} çš„é€€æ¬¾ç”³è¯·å·²é€šè¿‡ï¼`);
                                    
                                    if (currentUser && order.userId === currentUser.id) {
                                        updateUserOrders();
                                        showReviewMessageWithSound('é€€æ¬¾ç”³è¯·é€šè¿‡', 'æ‚¨çš„é€€æ¬¾ç”³è¯·å·²é€šè¿‡ï¼Œé€€æ¬¾å°†å¾ˆå¿«å¤„ç†ï¼');
                                    }
                                    
                                    alert('é€€æ¬¾ç”³è¯·å·²é€šè¿‡ï¼');
                                }
                            } catch (error) {
                                console.error('å®¡æ ¸é€€æ¬¾ç”³è¯·å¤±è´¥:', error);
                                alert('å®¡æ ¸å¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        });
                    });
                    
                    document.querySelectorAll('.reject-btn[data-refund-order]').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const orderId = this.dataset.refundOrder;
                            try {
                                const allOrders = await storageManager.get('orders') || [];
                                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                                
                                if (orderIndex !== -1) {
                                    const reason = prompt('è¯·è¾“å…¥æ‹’ç»é€€æ¬¾çš„åŸå› :');
                                    
                                    if (reason === null) return;
                                    
                                    allOrders[orderIndex].refundStatus = 'rejected';
                                    allOrders[orderIndex].refundReviewReason = reason;
                                    allOrders[orderIndex].refundReviewTime = new Date().toISOString();
                                    
                                    await storageManager.save('orders', allOrders);
                                    updateAdminPanel();
                                    
                                    const order = allOrders[orderIndex];
                                    // æ˜¾ç¤ºå®¡æ ¸æœªé€šè¿‡çš„å¼¹çª—
                                    showReviewMessageWithSound('é€€æ¬¾å®¡æ ¸æœªé€šè¿‡', `è®¢å• #${order.id} çš„é€€æ¬¾ç”³è¯·å·²è¢«æ‹’ç»ï¼`);
                                    
                                    if (currentUser && order.userId === currentUser.id) {
                                        updateUserOrders();
                                        showReviewMessageWithSound('é€€æ¬¾ç”³è¯·è¢«æ‹’ç»', `æ‚¨çš„é€€æ¬¾ç”³è¯·è¢«æ‹’ç»ï¼ŒåŸå› : ${reason}`);
                                    }
                                    
                                    alert('é€€æ¬¾ç”³è¯·å·²æ‹’ç»ï¼');
                                }
                            } catch (error) {
                                console.error('æ‹’ç»é€€æ¬¾ç”³è¯·å¤±è´¥:', error);
                                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        });
                    });
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®¡æ ¸çš„è®¢å•ï¼Œç¦ç”¨æˆ–å¯ç”¨åˆ é™¤æŒ‰é’®
                const pendingOrders = allOrders.filter(order => order.status === 'pending');
                if (pendingOrders.length > 0) {
                    deleteAllDataBtn.disabled = true;
                    deleteAllDataBtn.title = 'æœ‰æœªå®¡æ ¸çš„è®¢å•ï¼Œæ— æ³•åˆ é™¤æ•°æ®';
                } else {
                    deleteAllDataBtn.disabled = false;
                    deleteAllDataBtn.title = 'åˆ é™¤æ‰€æœ‰æ•°æ®';
                }
                
            } catch (error) {
                console.error('æ›´æ–°åå°é¢æ¿å¤±è´¥:', error);
                userList.innerHTML = '<div class="user-item">åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥</div>';
                adminOrderList.innerHTML = '<div class="order-item">åŠ è½½è®¢å•æ•°æ®å¤±è´¥</div>';
                processedOrderList.innerHTML = '<div class="order-item">åŠ è½½å·²å¤„ç†è®¢å•æ•°æ®å¤±è´¥</div>';
                adminMessageList.innerHTML = '<div class="message-item-admin">åŠ è½½æ¶ˆæ¯æ•°æ®å¤±è´¥</div>';
                pendingRefundList.innerHTML = '<div class="refund-item">åŠ è½½é€€æ¬¾æ•°æ®å¤±è´¥</div>';
                processedRefundList.innerHTML = '<div class="refund-item">åŠ è½½å·²å¤„ç†é€€æ¬¾æ•°æ®å¤±è´¥</div>';
                alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // æ›´æ–°ç»™ç”¨æˆ·å‘æ¶ˆæ¯çš„é€‰æ‹©æ¡†
        function updateSendToUserSelect(allUsers) {
            sendToUserSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            
            if (allUsers.length === 0) {
                return;
            }
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.server}) - ${user.wechat} - ç¢ç‰‡: ${user.fragments || 0}ä¸ª`;
                sendToUserSelect.appendChild(option);
            });
        }
        
        // å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·
        async function sendMessageToUser() {
            const userId = sendToUserSelect.value;
            const content = adminMessageContent.value.trim();
            
            if (!userId) {
                alert('è¯·é€‰æ‹©ç”¨æˆ·');
                return;
            }
            
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            try {
                const allMessages = await storageManager.get('messages') || [];
                const allUsers = await storageManager.get('users') || [];
                
                const user = allUsers.find(u => u.id === userId);
                if (!user) {
                    alert('ç”¨æˆ·ä¸å­˜åœ¨');
                    return;
                }
                
                // åˆ›å»ºå®¢æœæ¶ˆæ¯
                const adminMessage = {
                    id: 'msg-admin-' + Date.now(),
                    userId: userId,
                    userName: user.name,
                    userServer: user.server,
                    userWechat: user.wechat,
                    type: 'admin',
                    content: content,
                    timestamp: new Date().toISOString(),
                    status: 'unread' // è®¾ç½®ä¸ºæœªè¯»ï¼Œç”¨æˆ·ç«¯ä¼šå¼¹çª—æç¤º
                };
                
                allMessages.push(adminMessage);
                
                await storageManager.save('messages', allMessages);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                adminMessageContent.value = '';
                
                alert('æ¶ˆæ¯å·²å‘é€ï¼ç”¨æˆ·å°†æ”¶åˆ°å¼¹çª—é€šçŸ¥ã€‚');
                
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä¸€é”®åˆ é™¤æ‰€æœ‰æ•°æ®
        async function deleteAllData() {
            // å†æ¬¡ç¡®è®¤
            const confirmDelete = confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰è®¢å•ã€æ¶ˆæ¯å’Œç”¨æˆ·æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼\n\næ‚¨ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ');
            
            if (!confirmDelete) {
                return;
            }
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®¡æ ¸çš„è®¢å•
                const allOrders = await storageManager.get('orders') || [];
                const pendingOrders = allOrders.filter(order => order.status === 'pending');
                
                if (pendingOrders.length > 0) {
                    alert(`æ— æ³•åˆ é™¤æ•°æ®ï¼Œè¿˜æœ‰ ${pendingOrders.length} ä¸ªæœªå®¡æ ¸çš„è®¢å•ï¼\nè¯·å…ˆå®¡æ ¸æ‰€æœ‰è®¢å•åå†åˆ é™¤æ•°æ®ã€‚`);
                    return;
                }
                
                // åˆ é™¤è®¢å•æ•°æ®
                await storageManager.remove('orders');
                console.log('å·²åˆ é™¤è®¢å•æ•°æ®');
                
                // åˆ é™¤æ¶ˆæ¯æ•°æ®
                await storageManager.remove('messages');
                console.log('å·²åˆ é™¤æ¶ˆæ¯æ•°æ®');
                
                // åˆ é™¤ç”¨æˆ·æ•°æ®
                await storageManager.remove('users');
                console.log('å·²åˆ é™¤ç”¨æˆ·æ•°æ®');
                
                // åˆ é™¤ç­¾åˆ°è®°å½•
                await storageManager.remove('signs');
                console.log('å·²åˆ é™¤ç­¾åˆ°è®°å½•');
                
                alert('æ‰€æœ‰æ•°æ®å·²æˆåŠŸåˆ é™¤ï¼');
                
                // åˆ·æ–°åå°é¢æ¿
                updateAdminPanel();
                
            } catch (error) {
                console.error('åˆ é™¤æ•°æ®å¤±è´¥:', error);
                alert('åˆ é™¤æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ¸¸æˆåç§°å¼¹çª—ç¡®è®¤äº‹ä»¶
        gameNameConfirmBtn.addEventListener('click', function() {
            const name = gameNameInput.value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥æ¸¸æˆåç§°');
                return;
            }
            console.log('æ¸¸æˆåç§°è¾“å…¥:', name);
            sessionStorage.setItem('tempGameName', name);
            gameNameModal.style.display = 'none';
            serverModal.style.display = 'flex';
        });
        
        // åŒºæœå¼¹çª—ç¡®è®¤äº‹ä»¶
        serverConfirmBtn.addEventListener('click', function() {
            const server = serverSelect.value;
            const name = sessionStorage.getItem('tempGameName');
            
            console.log('åŒºæœé€‰æ‹©:', server);
            console.log('æ¸¸æˆåç§°:', name);
            
            if (!server) {
                alert('è¯·é€‰æ‹©åŒºæœ');
                return;
            }
            
            if (!name) {
                alert('æ¸¸æˆåç§°ä¸¢å¤±ï¼Œè¯·é‡æ–°è¾“å…¥');
                serverModal.style.display = 'none';
                gameNameModal.style.display = 'flex';
                return;
            }
            
            sessionStorage.setItem('tempServer', server);
            serverModal.style.display = 'none';
            wechatModal.style.display = 'flex';
            wechatInput1.focus();
        });
        
        // å¾®ä¿¡å·å¼¹çª—ç¡®è®¤äº‹ä»¶
        wechatConfirmBtn.addEventListener('click', async function() {
            const wechat1 = wechatInput1.value.trim();
            const wechat2 = wechatInput2.value.trim();
            const name = sessionStorage.getItem('tempGameName');
            const server = sessionStorage.getItem('tempServer');
            
            if (!wechat1 || !wechat2) {
                alert('è¯·è¾“å…¥å¾®ä¿¡å·/æ‰‹æœºå·');
                return;
            }
            
            // éªŒè¯å¾®ä¿¡å·æ˜¯å¦ä»¥wxidå¼€å¤´
            if (!validateWechat(wechat1)) {
                alert('å¾®ä¿¡å·ä¸èƒ½ä»¥wxidå¼€å¤´ï¼Œè¯·è¾“å…¥æ‰‹æœºå·æˆ–æ›´æ”¹å¾®ä¿¡å·');
                wechatError.style.display = 'block';
                wechatError.textContent = 'å¾®ä¿¡å·ä¸èƒ½ä»¥wxidå¼€å¤´ï¼Œè¯·è¾“å…¥æ‰‹æœºå·æˆ–æ›´æ”¹å¾®ä¿¡å·';
                wechatInput1.value = '';
                wechatInput2.value = '';
                wechatInput1.focus();
                return;
            }
            
            if (wechat1 !== wechat2) {
                wechatError.style.display = 'block';
                wechatError.textContent = 'ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥';
                wechatInput1.value = '';
                wechatInput2.value = '';
                wechatInput1.focus();
                return;
            }
            
            wechatError.style.display = 'none';
            
            if (!name || !server) {
                alert('ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°å¼€å§‹');
                wechatModal.style.display = 'none';
                gameNameModal.style.display = 'flex';
                return;
            }
            
            try {
                loading.style.display = 'flex';
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥å¾®ä¿¡å·çš„ç”¨æˆ·
                const allUsers = await storageManager.get('users') || [];
                let existingUser = allUsers.find(user => user.wechat === wechat1);
                
                if (existingUser) {
                    // æ›´æ–°ç°æœ‰ç”¨æˆ·ä¿¡æ¯
                    existingUser.name = name;
                    existingUser.server = server;
                    existingUser.lastLoginTime = new Date().toISOString();
                    console.log('æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼Œæ›´æ–°ä¿¡æ¯:', existingUser);
                } else {
                    // åˆ›å»ºæ–°ç”¨æˆ·
                    const userData = {
                        id: 'user-' + Date.now(),
                        name: name,
                        server: server,
                        wechat: wechat1,
                        registerTime: new Date().toISOString(),
                        lastLoginTime: new Date().toISOString(),
                        fragments: 0,
                        firstLotteryDone: false, // æ–°ç”¨æˆ·é¦–æ¬¡æŠ½å¥–æœªå®Œæˆ
                        lastSignDate: null // æ–°ç”¨æˆ·æœªç­¾åˆ°
                    };
                    
                    allUsers.push(userData);
                    existingUser = userData;
                    console.log('åˆ›å»ºæ–°ç”¨æˆ·:', userData);
                }
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°äº‘ç«¯
                const saveResult = await storageManager.save('users', allUsers);
                
                if (!saveResult) {
                    throw new Error('ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°äº‘ç«¯å¤±è´¥');
                }
                
                currentUser = existingUser;
                
                // ä¿å­˜ç™»å½•çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆ14å¤©å…ç™»å½•ï¼‰
                saveLoginState(existingUser);
                
                // æ¸…é™¤ä¸´æ—¶æ•°æ®
                sessionStorage.removeItem('tempGameName');
                sessionStorage.removeItem('tempServer');
                
                wechatModal.style.display = 'none';
                showMainApp();
                console.log('ç”¨æˆ·ç™»å½•æˆåŠŸ');
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        });
        
        // é€€å‡ºç™»å½•äº‹ä»¶
        logoutBtn.addEventListener('click', async function() {
            try {
                currentUser = null;
                
                // æ¸…é™¤æœ¬åœ°ç™»å½•çŠ¶æ€
                clearLoginState();
                
                // æ¸…é™¤æ‰€æœ‰ä¼šè¯å­˜å‚¨
                sessionStorage.clear();
                
                mainContainer.style.display = 'none';
                showLoginModal();
                
                // æ¸…é™¤æ¶ˆæ¯æ£€æŸ¥å®šæ—¶å™¨
                if (messageRefreshTimer) {
                    clearInterval(messageRefreshTimer);
                    messageRefreshTimer = null;
                }
                
                console.log('ç”¨æˆ·å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                alert('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });
        
        // å¯¼èˆªåˆ‡æ¢
        navItems.forEach(item => {
            item.addEventListener('click', async function() {
                const pageId = this.dataset.page;
                
                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
                
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                if (pageId === 'profilePage' && currentUser) {
                    updateUserOrders();
                    // æ›´æ–°ç¢ç‰‡æ˜¾ç¤º
                    await updateProfileFragmentDisplay();
                }
                
                if (pageId === 'messagePage' && currentUser) {
                    loadUserMessages();
                    // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯10ç§’åˆ·æ–°ä¸€æ¬¡æ¶ˆæ¯
                    if (window.messageRefreshTimer) {
                        clearInterval(window.messageRefreshTimer);
                    }
                    window.messageRefreshTimer = setInterval(loadUserMessages, 10000);
                } else {
                    // ç¦»å¼€å®¢æœé¡µé¢ï¼Œæ¸…é™¤å®šæ—¶å™¨
                    if (window.messageRefreshTimer) {
                        clearInterval(window.messageRefreshTimer);
                        window.messageRefreshTimer = null;
                    }
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°ä¸»é¡µï¼Œé‡æ–°ç”Ÿæˆè®¢å•ä»¥æ›´æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€
                if (pageId === 'homePage' && currentUser) {
                    await generateOrders();
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°åˆ†ç±»é¡µï¼Œé‡æ–°ç”Ÿæˆåˆ†ç±»è®¢å•ä»¥æ›´æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€
                if (pageId === 'categoryPage' && currentUser) {
                    await generateCategoryOrders();
                }
            });
        });
        
        // åå°ç®¡ç†æ ‡ç­¾é¡µåˆ‡æ¢
        adminTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                adminTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                adminTabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                
                // å¦‚æœåˆ‡æ¢åˆ°"ç»™ç”¨æˆ·å‘æ¶ˆæ¯"æ ‡ç­¾é¡µï¼Œæ›´æ–°ç”¨æˆ·åˆ—è¡¨
                if (tabId === 'sendMessageTab') {
                    updateSendToUserSelectOnTab();
                }
            });
        });
        
        // æ›´æ–°"ç»™ç”¨æˆ·å‘æ¶ˆæ¯"æ ‡ç­¾é¡µçš„ç”¨æˆ·åˆ—è¡¨
        async function updateSendToUserSelectOnTab() {
            try {
                const allUsers = await storageManager.get('users') || [];
                updateSendToUserSelect(allUsers);
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // ç¡®è®¤ä¸‹å•
        confirmOrderBtn.addEventListener('click', async function() {
            const selectedSpecElement = document.querySelector('.spec-modal.active');
            
            if (!selectedSpecElement) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè§„æ ¼');
                return;
            }
            
            try {
                const specData = currentOrder.specs[selectedSpec];
                
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                showOrderLoading();
                
                // ä¿å­˜è®¢å•æ•°æ®åˆ°æœåŠ¡å™¨
                const orderData = {
                    id: 'order-' + Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userServer: currentUser.server,
                    userWechat: currentUser.wechat,
                    orderTitle: currentOrder.title,
                    spec: specData.name,
                    price: specData.price,
                    originalPrice: specData.originalPrice,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                };
                
                console.log('æ­£åœ¨åˆ›å»ºè®¢å•...', orderData);
                
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼Œå±•ç¤ºåŠ è½½æ•ˆæœ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const allOrders = await storageManager.get('orders') || [];
                allOrders.push(orderData);
                const saveResult = await storageManager.save('orders', allOrders);
                
                if (!saveResult) {
                    throw new Error('ä¿å­˜è®¢å•åˆ°æœåŠ¡å™¨å¤±è´¥');
                }
                
                console.log('è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID:', orderData.id);
                
                // å…³é—­åŠ è½½åŠ¨ç”»
                hideOrderLoading();
                
                // å…³é—­ä¸‹å•å¼¹çª—ï¼Œæ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
                orderModal.style.display = 'none';
                showPaymentModal(currentOrder, selectedSpec);
                
                // æ›´æ–°ç”¨æˆ·è®¢å•åˆ—è¡¨
                await updateUserOrders();
            } catch (error) {
                console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
                // å…³é—­åŠ è½½åŠ¨ç”»
                hideOrderLoading();
                alert('ä¸‹å•å¤±è´¥: ' + error.message);
            }
        });
        
        // å–æ¶ˆä¸‹å•
        cancelOrderBtn.addEventListener('click', function() {
            orderModal.style.display = 'none';
            selectedSpec = null;
        });
        
        // å–æ¶ˆä¼ ä¸–æ­¦å™¨æŠ½å¥–
        cancelLotteryBtn.addEventListener('click', function() {
            lotteryModal.style.display = 'none';
            selectedPrize = null;
        });
        
        // å–æ¶ˆä¼ ä¸–è£…å¤‡æŠ½å¥–
        cancelEquipmentLotteryBtn.addEventListener('click', function() {
            equipmentLotteryModal.style.display = 'none';
            selectedEquipmentPrize = null;
        });
        
        // å…³é—­ç­¾åˆ°å¼¹çª—
        signCloseBtn.addEventListener('click', function() {
            signModal.style.display = 'none';
        });
        
        // æ”¯ä»˜ç¡®è®¤
        paymentConfirmBtn.addEventListener('click', function() {
            paymentModal.style.display = 'none';
            showReviewMessage('è¯·è”ç³»æ¸¸é¾™æ”¯ä»˜', 'æ·»åŠ æ¸¸é¾™å¾®ä¿¡æ”¯ä»˜ï¼Œæœ¬å•æ”¯æŒ7å¤©æ— ç†ç”±é€€æ¬¾ã€è”ç³»å®¢æœã€‘');
            selectedSpec = null;
        });
        
        // å®¡æ ¸å¼¹çª—å…³é—­
        reviewCloseBtn.addEventListener('click', function() {
            reviewModal.style.display = 'none';
        });
        
        // å–æ¶ˆé€€æ¬¾ç”³è¯·
        cancelRefundBtn.addEventListener('click', function() {
            refundModal.style.display = 'none';
        });
        
        // åå°ç®¡ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        adminBtn.addEventListener('click', function() {
            adminPasswordModal.style.display = 'flex';
        });
        
        // åå°å¯†ç éªŒè¯
        adminPasswordBtn.addEventListener('click', function() {
            const password = adminPasswordInput.value;
            
            if (password === ADMIN_PASSWORD) {
                adminPasswordModal.style.display = 'none';
                adminModal.style.display = 'flex';
                adminPasswordInput.value = '';
                updateAdminPanel();
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
                adminPasswordInput.value = '';
            }
        });
        
        // åå°åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        adminRefreshBtn.addEventListener('click', async function() {
            // æ·»åŠ ç‚¹å‡»åé¦ˆ
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fa fa-refresh fa-spin" style="margin-right: 5px;"></i>åˆ·æ–°ä¸­...';
            this.disabled = true;
            
            try {
                await updateAdminPanel();
                // çŸ­æš‚æ˜¾ç¤ºæˆåŠŸæç¤º
                const originalBackground = this.style.background;
                this.style.background = '#4CAF50';
                setTimeout(() => {
                    this.style.background = originalBackground;
                }, 300);
            } catch (error) {
                console.error('åˆ·æ–°åå°æ•°æ®å¤±è´¥:', error);
            } finally {
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }, 500);
            }
        });
        
        adminCloseBtn.addEventListener('click', function() {
            adminModal.style.display = 'none';
        });
        
        // æ·»åŠ åå°å¯†ç å¼¹çª—å…³é—­æŒ‰é’®äº‹ä»¶
        document.getElementById('adminPasswordCloseBtn').addEventListener('click', function() {
            adminPasswordModal.style.display = 'none';
        });
        
        // å‘é€æ¶ˆæ¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendMessageBtn.addEventListener('click', sendMessage);
        
        // æ¶ˆæ¯è¾“å…¥æ¡†å›è½¦å‘é€
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // ç»™ç”¨æˆ·å‘æ¶ˆæ¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendMessageToUserBtn.addEventListener('click', sendMessageToUser);
        
        // ä¸€é”®åˆ é™¤æ•°æ®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        deleteAllDataBtn.addEventListener('click', deleteAllData);
        
        // è”ç³»å®¢æœæ‚¬æµ®çƒç‚¹å‡»äº‹ä»¶
        floatingSupport.addEventListener('click', function() {
            // åˆ‡æ¢åˆ°å®¢æœé¡µé¢
            navItems.forEach(nav => nav.classList.remove('active'));
            document.querySelector('.nav-item[data-page="messagePage"]').classList.add('active');
            
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById('messagePage').classList.add('active');
            
            // åŠ è½½ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
            if (currentUser) {
                loadUserMessages();
            } else {
                // å¦‚æœæœªç™»å½•ï¼Œæç¤ºç”¨æˆ·å…ˆç™»å½•
                showReviewMessage('è¯·å…ˆç™»å½•', 'è¯·å…ˆç™»å½•åä½¿ç”¨å®¢æœåŠŸèƒ½');
            }
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // æ·»åŠ ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­åŠŸèƒ½ - ä¿®æ”¹ç‰ˆï¼šç™»å½•å¼¹çª—ä¸å…³é—­
        document.querySelectorAll('.modal, .lottery-modal, .sign-modal').forEach(modal => {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç™»å½•ç›¸å…³çš„å¼¹çª—ï¼ˆæ¸¸æˆåç§°ã€åŒºæœã€å¾®ä¿¡å·å¼¹çª—ï¼‰
            if (modal.id === 'gameNameModal' || modal.id === 'serverModal' || modal.id === 'wechatModal') {
                // ç™»å½•å¼¹çª—ä¸æ·»åŠ èƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
                return;
            }
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
        
        // æ·»åŠ è£…å¤‡æŠ½å¥–å¼¹çª—èƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
        equipmentLotteryModal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
        
        // æ·»åŠ å¾®ä¿¡å·è¾“å…¥å®æ—¶éªŒè¯
        wechatInput1.addEventListener('input', function() {
            const wechat = this.value.trim();
            if (!validateWechat(wechat) && wechat.toLowerCase().startsWith('wxid')) {
                wechatError.style.display = 'block';
                wechatError.textContent = 'å¾®ä¿¡å·ä¸èƒ½ä»¥wxidå¼€å¤´ï¼Œè¯·è¾“å…¥æ‰‹æœºå·æˆ–æ›´æ”¹å¾®ä¿¡å·';
            } else if (wechatError.style.display === 'block' && wechatError.textContent.includes('wxid')) {
                wechatError.style.display = 'none';
            }
        });
        
        wechatInput2.addEventListener('input', function() {
            const wechat1 = wechatInput1.value.trim();
            const wechat2 = this.value.trim();
            
            if (wechat1 && wechat2 && wechat1 !== wechat2) {
                wechatError.style.display = 'block';
                wechatError.textContent = 'ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥';
            } else if (wechatError.style.display === 'block' && wechatError.textContent.includes('ä¸ä¸€è‡´')) {
                wechatError.style.display = 'none';
            }
        });
        
        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>